section .text

global _ImageUtil_SwapRGB
global ImageUtil_SwapRGB
global _ImageUtil_ColorReplace32
global ImageUtil_ColorReplace32
global _ImageUtil_ColorReplace32A
global ImageUtil_ColorReplace32A
global _ImageUtil_ColorReplace32A2
global ImageUtil_ColorReplace32A2
global _ImageUtil_ColorFill32
global ImageUtil_ColorFill32
global _ImageUtil_ImageColorReplace32
global ImageUtil_ImageColorReplace32
global _ImageUtil_ImageMaskABlend32
global ImageUtil_ImageMaskABlend32
global _ImageUtil_ImageMask2ABlend32
global ImageUtil_ImageMask2ABlend32
global _ImageUtil_ImageColorBuffer32
global ImageUtil_ImageColorBuffer32
global _ImageUtil_ImageColorFill32
global ImageUtil_ImageColorFill32
global _ImageUtil_ImageColorBlend32
global ImageUtil_ImageColorBlend32
global _ImageUtil_ImageFillAlpha32
global ImageUtil_ImageFillAlpha32
global _ImageUtil_ImageAlphaMul32
global ImageUtil_ImageAlphaMul32
global _ImageUtil_ImageColorMul32
global ImageUtil_ImageColorMul32
global _ImageUtil_DrawRectNA32
global ImageUtil_DrawRectNA32
global _ImageUtil_ConvP1_ARGB32
global ImageUtil_ConvP1_ARGB32
global _ImageUtil_ConvP2_ARGB32
global ImageUtil_ConvP2_ARGB32
global _ImageUtil_ConvP4_ARGB32
global ImageUtil_ConvP4_ARGB32
global _ImageUtil_ConvP8_ARGB32
global ImageUtil_ConvP8_ARGB32
global _ImageUtil_ConvP1_A1_ARGB32
global ImageUtil_ConvP1_A1_ARGB32
global _ImageUtil_ConvP2_A1_ARGB32
global ImageUtil_ConvP2_A1_ARGB32
global _ImageUtil_ConvP4_A1_ARGB32
global ImageUtil_ConvP4_A1_ARGB32
global _ImageUtil_ConvP8_A1_ARGB32
global ImageUtil_ConvP8_A1_ARGB32
global _ImageUtil_ConvB5G5R5_ARGB32
global ImageUtil_ConvB5G5R5_ARGB32
global _ImageUtil_ConvB5G6R5_ARGB32
global ImageUtil_ConvB5G6R5_ARGB32
global _ImageUtil_ConvB8G8R8_ARGB32
global ImageUtil_ConvB8G8R8_ARGB32
global _ImageUtil_ConvR8G8B8_ARGB32
global ImageUtil_ConvR8G8B8_ARGB32
global _ImageUtil_ConvARGB32_B8G8R8
global ImageUtil_ConvARGB32_B8G8R8
global _ImageUtil_ConvR8G8B8A8_ARGB32
global ImageUtil_ConvR8G8B8A8_ARGB32
global _ImageUtil_ConvR8G8B8N8_ARGB32
global ImageUtil_ConvR8G8B8N8_ARGB32
global _ImageUtil_ConvARGB48_32
global ImageUtil_ConvARGB48_32
global _ImageUtil_ConvARGB64_32
global ImageUtil_ConvARGB64_32
global _ImageUtil_ConvA2B10G10R10_32
global ImageUtil_ConvA2B10G10R10_32
global _ImageUtil_ConvFB32G32R32A32_32
global ImageUtil_ConvFB32G32R32A32_32
global _ImageUtil_ConvFB32G32R32_32
global ImageUtil_ConvFB32G32R32_32
global _ImageUtil_ConvFW32A32_32
global ImageUtil_ConvFW32A32_32
global _ImageUtil_ConvFW32_32
global ImageUtil_ConvFW32_32
global _ImageUtil_ConvP1_ARGB64
global ImageUtil_ConvP1_ARGB64
global _ImageUtil_ConvP2_ARGB64
global ImageUtil_ConvP2_ARGB64
global _ImageUtil_ConvP4_ARGB64
global ImageUtil_ConvP4_ARGB64
global _ImageUtil_ConvP8_ARGB64
global ImageUtil_ConvP8_ARGB64
global _ImageUtil_ConvP1_A1_ARGB64
global ImageUtil_ConvP1_A1_ARGB64
global _ImageUtil_ConvP2_A1_ARGB64
global ImageUtil_ConvP2_A1_ARGB64
global _ImageUtil_ConvP4_A1_ARGB64
global ImageUtil_ConvP4_A1_ARGB64
global _ImageUtil_ConvP8_A1_ARGB64
global ImageUtil_ConvP8_A1_ARGB64
global _ImageUtil_ConvB5G5R5_ARGB64
global ImageUtil_ConvB5G5R5_ARGB64
global _ImageUtil_ConvB5G6R5_ARGB64
global ImageUtil_ConvB5G6R5_ARGB64
global _ImageUtil_ConvB8G8R8_ARGB64
global ImageUtil_ConvB8G8R8_ARGB64
global _ImageUtil_ConvR8G8B8_ARGB64
global ImageUtil_ConvR8G8B8_ARGB64
global _ImageUtil_ConvR8G8B8A8_ARGB64
global ImageUtil_ConvR8G8B8A8_ARGB64
global _ImageUtil_ConvARGB32_64
global ImageUtil_ConvARGB32_64
global _ImageUtil_ConvARGB48_64
global ImageUtil_ConvARGB48_64
global _ImageUtil_ConvA2B10G10R10_64
global ImageUtil_ConvA2B10G10R10_64
global _ImageUtil_ConvFB32G32R32A32_64
global ImageUtil_ConvFB32G32R32A32_64
global _ImageUtil_ConvFB32G32R32_64
global ImageUtil_ConvFB32G32R32_64
global _ImageUtil_ConvFW32A32_64
global ImageUtil_ConvFW32A32_64
global _ImageUtil_ConvFW32_64
global ImageUtil_ConvFW32_64
global _ImageUtil_ConvW16_ARGB32
global ImageUtil_ConvW16_ARGB32
global _ImageUtil_ConvW16A16_ARGB32
global ImageUtil_ConvW16A16_ARGB32
global _ImageUtil_ConvW8A8_ARGB32
global ImageUtil_ConvW8A8_ARGB32
global _ImageUtil_ConvW16_ARGB64
global ImageUtil_ConvW16_ARGB64
global _ImageUtil_ConvW16A16_ARGB64
global ImageUtil_ConvW16A16_ARGB64
global _ImageUtil_ConvW8A8_ARGB64
global ImageUtil_ConvW8A8_ARGB64
global _ImageUtil_Rotate32_CW90
global ImageUtil_Rotate32_CW90
global _ImageUtil_Rotate32_CW180
global ImageUtil_Rotate32_CW180
global _ImageUtil_Rotate32_CW270
global ImageUtil_Rotate32_CW270
global _ImageUtil_Rotate64_CW90
global ImageUtil_Rotate64_CW90
global _ImageUtil_Rotate64_CW180
global ImageUtil_Rotate64_CW180
global _ImageUtil_Rotate64_CW270
global ImageUtil_Rotate64_CW270
global ImageUtil_HFlip32
global _ImageUtil_HFlip32
global ImageUtil_HFRotate32_CW90
global _ImageUtil_HFRotate32_CW90
global ImageUtil_HFRotate32_CW180
global _ImageUtil_HFRotate32_CW180
global ImageUtil_HFRotate32_CW270
global _ImageUtil_HFRotate32_CW270
global ImageUtil_HFlip64
global _ImageUtil_HFlip64
global ImageUtil_HFRotate64_CW90
global _ImageUtil_HFRotate64_CW90
global ImageUtil_HFRotate64_CW180
global _ImageUtil_HFRotate64_CW180
global ImageUtil_HFRotate64_CW270
global _ImageUtil_HFRotate64_CW270
global _ImageUtil_CopyShiftW
global ImageUtil_CopyShiftW
global _ImageUtil_UVInterleaveShiftW
global ImageUtil_UVInterleaveShiftW
global _ImageUtil_YUV_Y416ShiftW
global ImageUtil_YUV_Y416ShiftW

;void ImageUtil_SwapRGB(UInt8 *imgPtr, OSInt pixelCnt, OSInt bpp)
;0 esi
;4 retAddr
;8 imgPtr
;12 pixelCnt
;16 bpp
	align 16
_ImageUtil_SwapRGB:
ImageUtil_SwapRGB:
	push esi
	mov esi,dword [esp+8] ;imgData
	mov ecx,dword [esp+12] ;pixelCnt
	
	mov eax,dword [esp+16] ;bpp
	cmp eax,48
	jz srgb48start
	cmp eax,64
	jz srgb64start
	cmp eax,24
	jz srgb24start
	cmp eax,32
	jz srgb32start
	jmp srgbexit

	align 16
srgb48start:
	mov ax,word [esi]
	mov dx,word [esi+4]
	mov word [esi],dx
	mov word [esi+4],ax
	add esi,6
	dec ecx
	jnz srgb48start
	jmp srgbexit
	
	align 16
srgb64start:
	mov ax,word [esi]
	mov dx,word [esi+4]
	mov word [esi],dx
	mov word [esi+4],ax
	add esi,8
	dec ecx
	jnz srgb64start
	jmp srgbexit
	
	align 16
srgb24start:
	mov al,byte [esi]
	mov dl,byte [esi+2]
	mov byte [esi],dl
	mov byte [esi+2],al
	add esi,3
	dec ecx
	jnz srgb24start
	jmp srgbexit

	align 16
srgb32start:
	mov al,byte [esi]
	mov dl,byte [esi+2]
	mov byte [esi],dl
	mov byte [esi+2],al
	add esi,4
	dec ecx
	jnz srgb32start
	jmp srgbexit

	align 16
srgbexit:
	pop esi
	ret
	
;void ImageUtil_ColorReplace32(UInt8 *pixelPtr, OSInt w, OSInt h, Int32 col);
;0 ebx
;4 retAddr
;8 pixelPtr
;12 w
;16 h
;20 col

	align 16
_ImageUtil_ColorReplace32:
ImageUtil_ColorReplace32:
	push ebx
	mov eax,dword [esp+12] ;w
	mul dword [esp+16] ;h
	mov ebx,dword [esp+20] ;col
	mov edx,dword [esp+8] ;bits
	align 16
cr32lop:
	mov ecx,dword [edx]
	test ecx,ecx
	jz cr32lop2
	mov dword [edx],ebx
	align 16
cr32lop2:
	lea edx,[edx+4]
	dec eax
	jnz cr32lop
	pop ebx
	ret

;void ImageUtil_ColorReplace32A(UInt8 *pixelPtr, OSInt w, OSInt h, Int32 col);
;0 retAddr
;4 pixelPtr
;8 w
;12 h
;16 col
	align 16
_ImageUtil_ColorReplace32A:
ImageUtil_ColorReplace32A:
	mov eax,dword [esp+8]
	mul dword [esp+12]
	mov edx,dword [esp+4]
	mov ecx,eax
	movd xmm4,[esp+16]
	pxor xmm5,xmm5
	punpckldq xmm4,xmm4
	punpcklbw xmm4,xmm4
	shr ecx,1
	jnb cr32alop1
	movd xmm0,dword [edx]
	punpcklbw xmm0,xmm0
	punpcklbw xmm0,xmm5
	pmulhuw xmm0,xmm4
	packuswb xmm0,xmm5
	movd dword [edx],xmm0
	lea edx,[edx+4]
	align 16
cr32alop1:
	movq xmm0,[edx]
	punpcklbw xmm0,xmm5
	pmulhuw xmm0,xmm4
	packuswb xmm0,xmm5
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ecx
	jnz cr32alop1
	ret
	
;void ImageUtil_ColorReplace32A2(UInt8 *pixelPtr, OSInt w, OSInt h, Int32 col);
;0 retAddr
;4 pixelPtr
;8 w
;12 h
;16 col
	align 16
_ImageUtil_ColorReplace32A2:
ImageUtil_ColorReplace32A2:
	mov eax,dword [esp+8]
	mul dword [esp+12]
	mov edx,dword [esp+4] ;pixelPtr
	pxor xmm1,xmm1

	mov ecx,eax ;pxCnt
	movd xmm2,dword [esp+16]
	punpcklbw xmm2,xmm1
	align 16
cr32a2lop2a:
	mov eax,dword [edx]
	test eax,eax
	jz cr32a2lop2b
	movd xmm0,eax
	punpcklwd xmm0,xmm0
	punpcklbw xmm0,xmm0
	psrlw xmm0,1
	movdqa xmm3,xmm0
	pmullw xmm0,xmm2
	pmulhw xmm3,xmm2
	punpcklwd xmm0,xmm3
	psrld xmm0,15
	packssdw xmm0,xmm1
	packuswb xmm0,xmm1
	movd [edx],xmm0

	align 16
cr32a2lop2b:
	lea edx,[edx+4]
	dec ecx
	jnz cr32a2lop2a
	ret
	
;void ImageUtil_ImageColorReplace32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, Int32 col)
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
;36 col
	align 16
_ImageUtil_ImageColorReplace32:
ImageUtil_ImageColorReplace32:
	push esi
	push edi
	mov eax,dword [esp+20] ;w
	shl eax,2
	sub dword [esp+28],eax ;sbpl
	sub dword [esp+32],eax ;dbpl
	mov esi,dword [esp+12] ;srcPtr
	mov edi,dword [esp+16] ;destPtr

	mov eax,dword [esp+36] ;col
	mov ecx,dword [esp+24] ;h
	align 16
icr32lop10:
	mov edx,dword [esp+20] ;w
	align 16
icr32lop11:
	cmp dword [esi],0
	jz icr32lop12
	mov dword [edi],eax
icr32lop12:
	lea esi,[esi+4]
	lea edi,[edi+4]
	dec edx
	jnz icr32lop11

	add esi,dword [esp+28] ;sbpl
	add edi,dword [esp+32] ;dbpl
	dec ecx
	jnz icr32lop10
	
	pop edi
	pop esi
	ret

;void ImageUtil_ColorFill32(UInt8 *pixelPtr, OSInt pixelCnt, Int32 color);
;0 edi
;4 retAddr
;8 pixelPtr
;12 pixelCnt
;16 color
	align 16
_ImageUtil_ColorFill32:
ImageUtil_ColorFill32:
	push edi
	mov edi,dword [esp+8] ;pixelPtr
	cld
	mov ecx,dword [esp+12] ;pixelCnt
	mov eax,dword [esp+16] ;color
	rep stosd
	pop edi
	ret
	
;void ImageUtil_ImageMaskABlend32(UInt8 *maskPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, Int32 col);
;0 edi
;4 esi
;8 retAddr
;12 maskPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
;36 col
	align 16
_ImageUtil_ImageMaskABlend32:
ImageUtil_ImageMaskABlend32:
	push esi
	push edi
	mov esi,dword [esp+12] ;maskPtr
	mov edi,dword [esp+16] ;destPtr
	
	mov eax,dword [esp+20] ;w
	shl eax,2
	sub dword [esp+28],eax ;sbpl
	sub dword [esp+32],eax ;dbpl

	mov eax,dword [esp+36] ;col
	mov edx,eax
	mov ecx,0xff
	shr edx,24
	sub ecx,edx
	and eax,0xffffff
	movd xmm4,edx
	movd xmm5,ecx
	movd xmm6,eax
	mov eax,0xff000000
	and eax,dword [esp+36] ;col
	movd xmm7,eax
	punpcklbw xmm4,xmm4
	punpcklbw xmm5,xmm5
	punpcklbw xmm4,xmm4
	punpcklbw xmm5,xmm5
	punpcklbw xmm4,xmm4
	punpcklbw xmm5,xmm5
	punpcklbw xmm7,xmm7
	punpcklbw xmm6,xmm6
	pmulhuw xmm4,xmm6
	por xmm4,xmm7
	pxor xmm7,xmm7

	mov ecx,dword [esp+24] ;h
	align 16
imab32lop10a:
	mov edx,dword [esp+20] ;w
	align 16
imab32lop11a:
	cmp dword [esi],0
	jz imab32lop12a
	movd xmm0,dword [edi]
	punpcklbw xmm0,xmm0
	pmulhuw xmm0,xmm5
	paddusw xmm0,xmm4
	psrlw xmm0,8
	packuswb xmm0,xmm7
	movd dword [edi],xmm0
	align 16
imab32lop12a:
	lea esi,[esi+4]
	lea edi,[edi+4]
	dec edx
	jnz imab32lop11a

	add esi,dword [esp+28] ;sbpl
	add edi,dword [esp+32] ;dbpl
	dec ecx
	jnz imab32lop10a
	pop edi
	pop esi
	ret

;void ImageUtil_ImageMask2ABlend32(UInt8 *maskPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, Int32 col1, Int32 col2)
;0 edi
;4 esi
;8 retAddr
;12 maskPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
;36 col1
;40 col2
	align 16
_ImageUtil_ImageMask2ABlend32:
ImageUtil_ImageMask2ABlend32:
	push esi
	push edi
	mov esi,dword [esp+12] ;maskPtr
	mov edi,dword [esp+16] ;destPtr
	
	mov eax,dword [esp+20] ;w
	shl eax,2
	sub dword [esp+28],eax ;sbpl
	mov dword [esp+32],eax ;dbpl

	mov edx,0xff000000
	mov ecx,0xffffffff
	movd xmm3,edx
	movd xmm4,ecx
	punpcklbw xmm3,xmm3 ;mortmp
	punpcklbw xmm4,xmm4 ;mtmp

	movzx eax,byte [esp+39] ;col1[3]
	movd xmm1,eax
	punpcklbw xmm1,xmm1
	punpcklbw xmm1,xmm1
	punpcklbw xmm1,xmm1
		
	movq xmm2,xmm1
	pxor xmm1,xmm4 ;mtmp
	movq xmm6,xmm1 ;cmul1
	por xmm2,xmm3 ;mortmp

	movd xmm7,[esp+36] ;col1
	punpcklbw xmm7,xmm7
	pmulhuw xmm7,xmm2 ;cadd1

	movzx eax,byte [esp+43] ;col2[3]
	movd xmm1,eax
	punpcklbw xmm1,xmm1
	punpcklbw xmm1,xmm1
	punpcklbw xmm1,xmm1
	
	movq xmm2,xmm1
	pxor xmm4,xmm1 ;mtmp cmul2
	por xmm2,xmm3 ;mortmp
	
	movd xmm5,[esp+40] ;col2
	punpcklbw xmm5,xmm5
	pmulhuw xmm5,xmm2 ;cadd2
	
	cld

	align 16
im2ab32lop3:
	mov ecx,dword [esp+20] ;w
	align 16
im2ab32lop:
	lodsd
	cmp eax,0xff000000
	jz im2ab32lop1
	cmp eax,0x00000000
	jz im2ab32lop2

	movd xmm0,[edi]
	punpcklbw xmm0,xmm0

	pmulhuw xmm0,xmm4 ;cmul2
	paddusw xmm0,xmm5 ;cadd2
	psrlw xmm0,8
	packuswb xmm0,xmm0
	movd [edi],xmm0

	jmp im2ab32lop1
	align 16
im2ab32lop2:
	movd xmm0,[edi]
	punpcklbw xmm0,xmm0

	pmulhuw xmm0,xmm6 ;cmul1
	paddusw xmm0,xmm7 ;cadd1
	psrlw xmm0,8
	packuswb xmm0,xmm0
	movd [edi],xmm0

	align 16
im2ab32lop1:
	add edi,4
	dec ecx
	jnz im2ab32lop
	
	add esi,dword [esp+28] ;sbpl
	add edi,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz im2ab32lop3
	
	pop esi
	pop edi
	ret

;void ImageUtil_ImageColorBuffer32(UInt8 *pixelPtr, OSInt w, OSInt h, OSInt bpl, OSInt buffSize)
;0 edi
;4 esi
;8 ebx
;12 ebp
;16 retAddr
;20 pixelPtr
;24 w
;28 h
;32 bpl
;36 buffSize
	align 16
_ImageUtil_ImageColorBuffer32:
ImageUtil_ImageColorBuffer32:
	push ebp
	push ebx
	push esi
	push edi
	mov esi,dword [esp+20] ;pixelPtr
	mov ebx,dword [esp+32] ;bpl
	mov eax,dword [esp+24] ;w
	shl eax,2
	sub ebx,eax ;bpl
	mov dword [esp-4],ebx ;bpl - w * 4
	mov ebx,dword [esp+36] ;buffSize
	
	align 16
icb32lop:
	mov ecx,dword [esp+24] ;w
	
	align 16
icb32lop2:
	test dword [esi],0x808080
	jz icb32lop3
	mov ebp,esi
	mov edi,esi
	xor eax,eax
	align 16
icb32lop4:
	mov edx,ebx ;buffSize
	sub edx,eax
	align 16
icb32lop7:
	cmp dword [ebp+edx*4],0
	jnz icb32lop6a
	mov dword [ebp+edx*4],0x7f7f7f
icb32lop6a:
	cmp dword [edi+edx*4],0
	jnz icb32lop6c
	mov dword [edi+edx*4],0x7f7f7f
icb32lop6c:
	neg edx
	cmp dword [ebp+edx*4],0
	jnz icb32lop6b
	mov dword [ebp+edx*4],0x7f7f7f
icb32lop6b:
	cmp dword [edi+edx*4],0
	jnz icb32lop6d
	mov dword [edi+edx*4],0x7f7f7f
icb32lop6d:
	neg edx
	jnb icb32lop5
	dec edx
	jmp icb32lop7
	
	align 16
icb32lop5:
	inc eax
	add ebp,dword [esp+32] ;bpl
	sub edi,dword [esp+32] ;bpl
	cmp eax,ebx
	jbe icb32lop4

	align 16
icb32lop3:
	add esi,4
	dec ecx
	jnz icb32lop2
	add esi,dword [esp-4] ;bpl - w * 4
	dec dword [esp+28] ;h
	jnz icb32lop
	
	pop edi
	pop esi
	pop ebx
	pop ebp
	ret
	
;void ImageUtil_ImageColorFill32(UInt8 *pixelPtr, OSInt w, OSInt h, OSInt bpl, Int32 col)
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 pixelPtr
;20 w
;24 h
;28 bpl
;32 col
	align 16
_ImageUtil_ImageColorFill32:
ImageUtil_ImageColorFill32:
	push ebx
	push esi
	push edi
	cld
	mov esi,dword [esp+20] ;w
	lea eax,[esi*4]
	mov edi,dword [esp+16] ;pixelPtr
	mov ebx,dword [esp+28] ;bpl
	sub ebx,eax
	mov eax,dword [esp+32] ;col
	mov edx,dword [esp+24] ;hleft
	align 16
icf32lop4:
	mov ecx,esi
	rep stosd
	add edi,ebx
	dec edx
	jnz icf32lop4
	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ImageColorBlend32(UInt8 *pixelPtr, OSInt w, OSInt h, OSInt bpl, Int32 col)
;0 retAddr
;4 pixelPtr
;8 w
;12 h
;16 bpl
;20 col
	align 16
_ImageUtil_ImageColorBlend32:
ImageUtil_ImageColorBlend32:
	movzx eax,byte [esp+23]
	mov edx,0xff000000
	mov ecx,0xffffffff
	movd xmm1,eax
	punpcklbw xmm1,xmm1
	punpcklbw xmm1,xmm1
	punpcklbw xmm1,xmm1
	
	movd xmm3,edx
	movd xmm4,ecx
	punpcklbw xmm3,xmm3 ;mortmp
	punpcklbw xmm4,xmm4 ;mtmp
	movq xmm2,xmm1
	pxor xmm1,xmm4
	movdqa xmm5,xmm1 ;cimul
	por xmm2,xmm3 ;mortmp

	movd xmm0,dword [esp+20]
	punpcklbw xmm0,xmm0
	pmulhuw xmm0,xmm2
	movq xmm6,xmm0 ;cadd
	pxor xmm3,xmm3

	mov eax,dword [esp+8] ;w
	shl eax,2
	sub dword [esp+16],eax ;bpl
	mov edx,dword [esp+4] ;initOfst
	align 16
icbl32lop:
	mov ecx,dword [esp+8] ;w2
	shr ecx,1
	align 16
icbl32lop2:
	movd xmm0,[edx]
	movd xmm1,[edx+4]
	punpcklbw xmm0,xmm0
	punpcklbw xmm1,xmm1

	pmulhuw xmm0,xmm5 ;cimul
	paddusw xmm0,xmm6 ;cadd
	psrlw xmm0,8
	pmulhuw xmm1,xmm5 ;cimul
	paddusw xmm1,xmm6 ;cadd
	psrlw xmm1,8
	packuswb xmm0,xmm1
	movq [edx],xmm0

	add edx,8
	dec ecx
	jnz icbl32lop2

	test dword [esp+8],1 ;w
	jz icbl32lop3

	movd xmm0,[edx]
	punpcklbw xmm0,xmm0

	pmulhuw xmm0,xmm5 ;cimul
	paddusw xmm0,xmm6 ;cadd
	psrlw xmm0,8
	packuswb xmm0,xmm3
	movd [edx],xmm0
	
	align 16
icbl32lop3:
	add edx,dword [esp+16] ;bpl
	dec dword [esp+12] ;hleft
	jnz icbl32lop
	ret
	
;void ImageUtil_ImageFillAlpha32(UInt8 *pixelPtr, OSInt w, OSInt h, OSInt bpl, UInt8 a);
;0 edi
;4 retAddr
;8 pixelPtr
;12 w
;16 h
;20 bpl
;24 a

	align 16
_ImageUtil_ImageFillAlpha32:
ImageUtil_ImageFillAlpha32:
	push edi
	mov eax,dword [esp+12] ;w
	shl eax,2
	sub dword [esp+20],eax ;bpl
	
	mov edi,dword [esp+8] ;pixelPtr
	mov edx,dword [esp+16] ;h
	mov al,byte [esp+24] ;a
	align 16
ifa32lop:
	mov ecx,dword [esp+12] ;w
	align 16
ifa32lop2:
	mov byte [edi+3],al
	add edi,4
	dec ecx
	jnz ifa32lop2
	add edi,dword [esp+20] ;bpl
	dec edx
	jnz ifa32lop
	pop edi
	ret

;void ImageUtil_ImageAlphaMul32(UInt8 *pixelPtr, OSInt w, OSInt h, OSInt bpl, UInt32 a);
;0 edi
;4 ebx
;8 retAddr
;12 pixelPtr
;16 w
;20 h
;24 bpl
;28 a

	align 16
_ImageUtil_ImageAlphaMul32:
ImageUtil_ImageAlphaMul32:
	push ebx
	push edi
	mov eax,dword [esp+16] ;w
	shl eax,2
	sub dword [esp+24],eax ;bpl
	mov edi,dword [esp+12] ;pbits
	mov ebx,dword [esp+28] ;v
	align 16
iam32lop2:
	mov ecx,dword [esp+16] ;w
	
	align 16
iam32lop:
	movzx eax,byte [edi+3]
	mul ebx
	shr eax,16
	mov byte [edi+3],al
	add edi,4
	dec ecx
	jnz iam32lop
	add edi,dword [esp+24] ;bpl
	dec dword [esp+20] ;h
	jnz iam32lop2
	pop edi
	pop ebx
	ret

;void ImageUtil_ImageColorMul32(UInt8 *pixelPtr, OSInt w, OSInt h, OSInt bpl, UInt32 c);
;0 edi
;4 ebx
;8 retAddr
;12 pixelPtr
;16 w
;20 h
;24 bpl
;28 c

	align 16
_ImageUtil_ImageColorMul32:
ImageUtil_ImageColorMul32:
	push ebx
	push edi
	mov eax,dword [esp+16] ;w
	shl eax,2
	sub dword [esp+24],eax ;bpl
	mov edi,dword [esp+12] ;pbits
	movd xmm1,dword [esp+28] ;c
	punpcklbw xmm1,xmm1
	pxor xmm2,xmm2
	align 16
icm32lop2:
	mov ecx,dword [esp+16] ;w
	
	align 16
icm32lop:
	movd xmm0, [edi]
	punpcklbw xmm0,xmm2
	pmulhuw xmm0,xmm1
	packuswb xmm0,xmm2
	movd dword [edi],xmm0
	add edi,4
	dec ecx
	jnz icm32lop
	add edi,dword [esp+24] ;bpl
	dec dword [esp+20] ;h
	jnz icm32lop2
	pop edi
	pop ebx
	ret

;void ImageUtil_DrawRectNA32(UInt8 *pixelPtr, OSInt w, OSInt h, OSInt bpl, UInt32 col)
;0 ebp
;4 edi
;8 esi
;12 ebx
;16 retAddr
;20 pixelPtr
;24 w
;28 h
;32 bpl
;36 col

	align 16
_ImageUtil_DrawRectNA32:
ImageUtil_DrawRectNA32:
	push ebx
	push esi
	push edi
	push ebp
	mov esi,dword [esp+20] ;pixelPtr
	mov ebp,dword [esp+32] ;bpl
	mov ebx,dword [esp+24] ;w
	lea edx,[ebx*4]
	mov edi,ebp
	mov eax,dword [esp+36] ;col
	sub ebp,edx
	sub dword [esp+28],2 ;h
	jb drna32exit
	jz drna32lop
	
	mov ecx,ebx ;w
	align 16
drna32lop2:
	mov dword [esi],eax
	lea esi,[esi+4]
	dec ecx
	jnz drna32lop2
	lea esi,[esi+ebp]
	
	align 16
drna32lop3:
	mov dword [esi],eax
	mov dword [esi+ebx*4-4],eax
	lea esi,[esi+edi]
	dec dword [esp+28]
	jnz drna32lop3
	
	mov ecx,ebx ;w
	align 16
drna32lop4:
	mov dword [esi],eax
	lea esi,[esi+4]
	dec ecx
	jnz drna32lop4
	jmp drna32exit

	align 16
drna32lop:	
	mov ecx,ebx ;w
	align 16
drna32lop5:
	mov dword [esi],eax
	lea esi,[esi+4]
	dec ecx
	jnz drna32lop5
	lea esi,[esi+ebp]

	mov ecx,ebx
	align 16
drna32lop6:
	mov dword [esi],eax
	lea esi,[esi+4]
	dec ecx
	jnz drna32lop6
	
	align 16
drna32exit:
	pop ebp
	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP1_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP1_ARGB32:
ImageUtil_ConvP1_ARGB32:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr
	mov edx,dword [esp+20] ;destPtr
	mov ebx,dword [esp+24] ;w
	test ebx,7
	jnz cargb1_32lop
	
	lea eax,[ebx*4]
	shr dword [esp+24],3 ;w
	shr ebx,3
	sub dword [esp+32],ebx ;sbpl
	sub dword [esp+36],eax ;dbpl
	align 16
cargb1_32lop2:
	mov ebx,dword [esp+24] ;w
	align 16
cargb1_32lop3:
	movzx eax,byte [ecx]
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+4],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+8],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+12],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+16],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+20],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+24],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+28],edi
	lea ecx,[ecx+1]
	lea edx,[edx+32]
	dec ebx
	jnz cargb1_32lop3
	
	add ecx,dword [esp+32] ;sbpl
	add edx,dword [esp+36] ;dbpl
	dec dword [esp+28] ;h
	jnz cargb1_32lop2
	jmp cargb1_32exit
	
	align 16
cargb1_32lop:
	lea eax,[ebx*4]
	shr ebx,3
	sub dword [esp+32],ebx ;sbpl
	sub dword [esp+36],eax ;dbpl
	align 16
cargb1_32lop4:
	mov ebx,dword [esp+24] ;w
	shr ebx,3
	jz cargb1_32lop7
	align 16
cargb1_32lop5:
	movzx eax,byte [ecx]
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+4],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+8],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+12],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+16],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+20],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+24],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+28],edi
	lea ecx,[ecx+1]
	lea edx,[edx+32]
	dec ebx
	jnz cargb1_32lop5

	align 16
cargb1_32lop7:
	mov ebx,dword [esp+24] ;w
	movzx eax,byte [ecx]
	and ebx,7
	align 16
cargb1_32lop6:
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	lea edx,[edx+4]
	dec ebx
	jnz cargb1_32lop6
	
	add ecx,dword [esp+32] ;sbpl
	add edx,dword [esp+36] ;dbpl
	dec dword [esp+28] ;h
	jnz cargb1_32lop4

	align 16
cargb1_32exit:
	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP2_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP2_ARGB32:
ImageUtil_ConvP2_ARGB32:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr
	mov edx,dword [esp+20] ;destPtr
	mov ebx,dword [esp+24] ;w
	test ebx,3
	jnz cargb2_32lop
	
	lea eax,[ebx*4]
	shr dword [esp+24],2 ;w
	shr ebx,2
	sub dword [esp+32],ebx ;sbpl
	sub dword [esp+36],eax ;dbpl
	align 16
cargb2_32lop2:
	mov ebx,dword [esp+24] ;w
	align 16
cargb2_32lop3:
	movzx eax,byte [ecx]
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx+4],edi
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx+8],edi
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx+12],edi
	lea ecx,[ecx+1]
	lea edx,[edx+16]
	dec ebx
	jnz cargb2_32lop3
	
	add ecx,dword [esp+32] ;sbpl
	add edx,dword [esp+36] ;dbpl
	dec dword [esp+28] ;h
	jnz cargb2_32lop2
	jmp cargb2_32exit
	
	align 16
cargb2_32lop:
	lea eax,[ebx*4]
	shr ebx,2
	sub dword [esp+32],ebx ;sbpl
	sub dword [esp+36],eax ;dbpl
	align 16
cargb2_32lop4:
	mov ebx,dword [esp+24] ;w
	shr ebx,2
	jz cargb2_32lop7
	align 16
cargb2_32lop5:
	movzx eax,byte [ecx]
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx+4],edi
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx+8],edi
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx+12],edi
	lea ecx,[ecx+1]
	lea edx,[edx+16]
	dec ebx
	jnz cargb2_32lop5

	align 16
cargb2_32lop7:
	mov ebx,dword [esp+24] ;w
	movzx eax,byte [ecx]
	and ebx,3
	align 16
cargb2_32lop6:
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	lea edx,[edx+4]
	dec ebx
	jnz cargb2_32lop6
	
	add ecx,dword [esp+32] ;sbpl
	add edx,dword [esp+36] ;dbpl
	dec dword [esp+28] ;h
	jnz cargb2_32lop4

	align 16
cargb2_32exit:
	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP4_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 esi
;4 ebx
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
;36 pal esi
	align 16
_ImageUtil_ConvP4_ARGB32:
ImageUtil_ConvP4_ARGB32:
	push ebx
	push esi
	mov esi,dword [esp+36] ;pal
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	mov ebx,dword [esp+20] ;w
	shr dword [esp+20],1 ;w
	jb cargb4_32lop
	
	lea eax,[ebx*4]
	shr ebx,1
	sub dword [esp+28],ebx ;sbpl
	sub dword [esp+32],eax ;dbpl
	align 16
cargb4_32lop2:
	mov ebx,dword [esp+20] ;w
	align 16
cargb4_32lop3:
	movzx eax,byte [ecx]
	shr eax,4
	mov eax,dword [esi+eax*4]
	movnti dword [edx],eax
	movzx eax,byte [ecx]
	and eax,15
	mov eax,dword [esi+eax*4]
	lea ecx,[ecx+1]
	movnti dword [edx+4],eax
	lea edx,[edx+8]
	dec ebx
	jnz cargb4_32lop3
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cargb4_32lop2
	jmp cargb4_32exit
	
	align 16
cargb4_32lop:
	lea eax,[ebx*4]
	shr ebx,1
	sub dword [esp+28],ebx ;sbpl
	sub dword [esp+32],eax ;dbpl
	align 16
cargb4_32lop4:
	mov ebx,dword [esp+20] ;w
	test ebx,ebx
	jz cargb4_32lop7
	align 16
cargb4_32lop5:
	movzx eax,byte [ecx]
	shr eax,4
	mov eax,dword [esi+eax*4]
	movnti dword [edx],eax
	movzx eax,byte [ecx]
	and eax,15
	mov eax,dword [esi+eax*4]
	lea ecx,[ecx+1]
	movnti dword [edx+4],eax
	lea edx,[edx+8]
	dec ebx
	jnz cargb4_32lop5

	align 16
cargb4_32lop7:
	movzx eax,byte [ecx]
	shr eax,4
	mov eax,dword [esi+eax*4]
	movnti dword [edx],eax
	lea edx,[edx+4]
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cargb4_32lop4

	align 16
cargb4_32exit:
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP8_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 esi
;4 ebx
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
;36 pal

	align 16
_ImageUtil_ConvP8_ARGB32:
ImageUtil_ConvP8_ARGB32:
	push ebx
	push esi
	mov esi,dword [esp+36] ;pal
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	
	mov ebx,dword [esp+20] ;w
	lea eax,[ebx*4]
	sub dword [esp+28],ebx ;sbpl
	sub dword [esp+32],eax ;dbpl
	align 16
cargb8_32lop:
	mov ebx,dword [esp+20] ;w
	align 16
cargb8_32lop2:
	movzx eax,byte [ecx]
	mov eax,dword [esi+eax*4]
	lea ecx,[ecx+1]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec ebx
	jnz cargb8_32lop2
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cargb8_32lop
	
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP1_A1_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP1_A1_ARGB32:
ImageUtil_ConvP1_A1_ARGB32:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr

	align 16
cp1_a1_32lop2:
	mov ebx,dword [esp+24] ;w
	mov edx,dword [esp+20] ;destPtr
	shr ebx,3
	
	align 16
cp1_a1_32lop3:
	movzx eax,byte [ecx]
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+4],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+8],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+12],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+16],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+20],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+24],edi
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx+28],edi
	lea ecx,[ecx+1]
	lea edx,[edx+32]
	dec ebx
	jnz cp1_a1_32lop3

	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp1_a1_32lop3b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp1_a1_32lop3a:
	rol al,1
	mov edi,eax
	and edi,1
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	lea edx,[edx+4]
	dec ebx
	jnz cp1_a1_32lop3a
	align 16
cp1_a1_32lop3b:
		
	mov ebx,dword [esp+24] ;w
	mov edi,dword [esp+20] ;destPtr
	shr ebx,3
	
	align 16
cp1_a1_32lop4:
	movzx eax,byte [ecx]
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+3],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+7],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+11],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+15],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+19],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+23],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+27],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+31],dl
	lea ecx,[ecx+1]
	lea edi,[edi+32]
	dec ebx
	jnz cp1_a1_32lop4

	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp1_a1_32lop4b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp1_a1_32lop4a:
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+3],dl
	lea edi,[edi+4]
	dec ebx
	jnz cp1_a1_32lop4a
	align 16
cp1_a1_32lop4b:
	
	mov eax,dword [esp+36] ;dbpl
	add dword [esp+20],eax
	dec dword [esp+28] ;h
	jnz cp1_a1_32lop2

	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP2_A1_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP2_A1_ARGB32:
ImageUtil_ConvP2_A1_ARGB32:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr

	align 16
cp2_a1_32lop2:
	mov ebx,dword [esp+24] ;w
	mov edx,dword [esp+20] ;destPtr
	shr ebx,2
	align 16
cp2_a1_32lop3:
	movzx eax,byte [ecx]
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx+4],edi
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx+8],edi
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx+12],edi
	lea ecx,[ecx+1]
	lea edx,[edx+16]
	dec ebx
	jnz cp2_a1_32lop3

	mov ebx,dword [esp+24] ;w
	and ebx,3
	jz cp2_a1_32lop3b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp2_a1_32lop3a:
	rol al,2
	mov edi,eax
	and edi,3
	mov edi,dword [esi+edi*4]
	movnti dword [edx],edi
	lea edx,[edx+4]
	dec ebx
	jnz cp2_a1_32lop3a
	align 16
cp2_a1_32lop3b:
	
	mov ebx,dword [esp+24] ;w
	mov edi,dword [esp+20] ;destPtr
	shr ebx,3
	
	align 16
cp2_a1_32lop4:
	movzx eax,byte [ecx]
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+3],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+7],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+11],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+15],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+19],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+23],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+27],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+31],dl
	lea ecx,[ecx+1]
	lea edi,[edi+32]
	dec ebx
	jnz cp2_a1_32lop4
	
	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp2_a1_32lop4b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp2_a1_32lop4a:
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+3],dl
	lea edi,[edi+4]
	dec ebx
	jnz cp2_a1_32lop4a
	align 16
cp2_a1_32lop4b:

	mov eax,dword [esp+36] ;dbpl
	add dword [esp+20],eax
	dec dword [esp+28] ;h
	jnz cp2_a1_32lop2
	
	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP4_A1_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP4_A1_ARGB32:
ImageUtil_ConvP4_A1_ARGB32:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr

	align 16
cp4_a1_32lop2:
	mov ebx,dword [esp+24] ;w
	mov edx,dword [esp+20] ;destPtr
	shr ebx,1
	align 16
cp4_a1_32lop3:
	movzx eax,byte [ecx]
	shr eax,4
	mov eax,dword [esi+eax*4]
	movnti dword [edx],eax
	movzx eax,byte [ecx]
	and eax,15
	mov eax,dword [esi+eax*4]
	lea ecx,[ecx+1]
	movnti dword [edx+4],eax
	lea edx,[edx+8]
	dec ebx
	jnz cp4_a1_32lop3
	
	test dword [esp+24],1 ;w
	jz cp4_a1_32lop3b
	movzx eax,byte [ecx]
	shr eax,4
	mov eax,dword [esi+eax*4]
	movnti dword [edx],eax
	lea ecx,[ecx+1]
	lea edx,[edx+4]
	
	align 16
cp4_a1_32lop3b:
	
	mov ebx,dword [esp+24] ;w
	mov edi,dword [esp+20] ;destPtr
	shr ebx,3
	
	align 16
cp4_a1_32lop4:
	movzx eax,byte [ecx]
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+3],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+7],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+11],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+15],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+19],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+23],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+27],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+31],dl
	lea ecx,[ecx+1]
	lea edi,[edi+32]
	dec ebx
	jnz cp4_a1_32lop4
	
	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp4_a1_32lop4b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp4_a1_32lop4a:
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+3],dl
	lea edi,[edi+4]
	dec ebx
	jnz cp4_a1_32lop4a
	align 16
cp4_a1_32lop4b:

	mov eax,dword [esp+36] ;dbpl
	add dword [esp+20],eax
	dec dword [esp+28] ;h
	jnz cp4_a1_32lop2

	pop	edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP8_A1_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal

	align 16
_ImageUtil_ConvP8_A1_ARGB32:
ImageUtil_ConvP8_A1_ARGB32:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr

	align 16
cp8_a1_32lop:
	mov ebx,dword [esp+24] ;w
	mov edx,dword [esp+20] ;destPtr
	align 16
cp8_a1_32lop2:
	movzx eax,byte [ecx]
	mov eax,dword [esi+eax*4]
	lea ecx,[ecx+1]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec ebx
	jnz cp8_a1_32lop2
	
	mov ebx,dword [esp+24] ;w
	mov edi,dword [esp+20] ;destPtr
	shr ebx,3
	
	align 16
cp8_a1_32lop4:
	movzx eax,byte [ecx]
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+3],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+7],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+11],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+15],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+19],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+23],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+27],dl
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+31],dl
	lea ecx,[ecx+1]
	lea edi,[edi+32]
	dec ebx
	jnz cp8_a1_32lop4
	
	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp8_a1_32lop4b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp8_a1_32lop4a:
	rol al,1
	mov edx,eax
	and edx,1
	neg dl
	mov byte [edi+3],dl
	lea edi,[edi+4]
	dec ebx
	jnz cp8_a1_32lop4a
	align 16
cp8_a1_32lop4b:

	mov eax,dword [esp+36] ;dbpl
	add dword [esp+20],eax
	dec dword [esp+28] ;h
	jnz cp8_a1_32lop
	
	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvB5G5R5_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl

	align 16
_ImageUtil_ConvB5G5R5_ARGB32:
ImageUtil_ConvB5G5R5_ARGB32:
	push ebx
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*2]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	mov eax,0x00840084
	movd xmm2,eax
	pxor xmm1,xmm1
	punpckldq xmm2,xmm2
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr

	align 16
cb5g5r5_32lop:
	mov ebx,dword [esp+16] ;w
	
	align 16
cb5g5r5_32lop2:
	movzx eax,word [ecx]
	and eax,0x7fff
	shl eax,6
	shr ax,3
	shr al,3
	movd xmm0, eax
	punpcklbw xmm0,xmm1
	pmullw xmm0, xmm2
	psrlw xmm0,4
	packuswb xmm0,xmm1
	movd dword [edx],xmm0
	mov byte [edx+3],0xff

	lea ecx,[ecx+2]
	lea edx,[edx+4]
	dec ebx
	jnz cb5g5r5_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cb5g5r5_32lop
	pop ebx
	ret

;void ImageUtil_ConvB5G6R5_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl

	align 16
_ImageUtil_ConvB5G6R5_ARGB32:
ImageUtil_ConvB5G6R5_ARGB32:
	push ebx
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*2]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	mov eax,0x00410084
	movd xmm2,eax
	pxor xmm1,xmm1
	punpckldq xmm2,xmm2
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr

	align 16
cb5g6r5_32lop:
	mov ebx,dword [esp+16] ;w
	
	align 16
cb5g6r5_32lop2:
	movzx eax,word [ecx]
	shl eax,5
	shr ax,2
	shr al,3
	movd xmm0, eax
	punpcklbw xmm0,xmm1
	pmullw xmm0, xmm2
	psrlw xmm0,4
	packuswb xmm0,xmm1
	movd dword [edx],xmm0
	mov byte [edx+3],0xff

	lea ecx,[ecx+2]
	lea edx,[edx+4]
	dec ebx
	jnz cb5g6r5_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cb5g6r5_32lop
	pop ebx
	ret

;void ImageUtil_ConvB8G8R8_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvB8G8R8_ARGB32:
ImageUtil_ConvB8G8R8_ARGB32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx+ebx*2]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb24_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb24_32lop2:
	movzx eax,byte [ecx+2]
	or eax,0xff00
	shl eax,16
	mov ax,word [ecx]
	lea ecx,[ecx+3]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec ebx
	jnz cargb24_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb24_32lop
	pop ebx
	ret
	
;void ImageUtil_ConvR8G8B8_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvR8G8B8_ARGB32:
ImageUtil_ConvR8G8B8_ARGB32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx+ebx*2]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb24r_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb24r_32lop2:
	movzx eax,byte [ecx]
	or eax,0xff00
	shl eax,16
	mov ah,byte [ecx+1]
	mov al,byte [ecx+2]
	lea ecx,[ecx+3]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec ebx
	jnz cargb24r_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb24r_32lop
	pop ebx
	ret

;void ImageUtil_ConvARGB32_B8G8R8(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvARGB32_B8G8R8:
ImageUtil_ConvARGB32_B8G8R8:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx+ebx*2]
	sub dword [esp+28],eax ;dbpl
	lea eax,[ebx*4]
	sub dword [esp+24],eax ;sbpl
	
	align 16
cargb32_24lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb32_24lop2:
	mov ax,word [ecx]
	mov word [edx],ax
	mov al,byte [ecx+2]
	mov byte [edx+2],al
	lea ecx,[ecx+4]
	lea edx,[edx+3]
	dec ebx
	jnz cargb32_24lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb32_24lop
	pop ebx
	ret

;void ImageUtil_ConvR8G8B8A8_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvR8G8B8A8_ARGB32:
ImageUtil_ConvR8G8B8A8_ARGB32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+24],eax ;sbpl
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb32r_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb32r_32lop2:
	movzx eax,byte [ecx]
	mov ah,byte [ecx+3]
	shl eax,16
	mov ah,byte [ecx+1]
	mov al,byte [ecx+2]
	lea ecx,[ecx+4]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec ebx
	jnz cargb32r_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb32r_32lop
	pop ebx
	ret


;void ImageUtil_ConvR8G8B8N8_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvR8G8B8N8_ARGB32:
ImageUtil_ConvR8G8B8N8_ARGB32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+24],eax ;sbpl
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb32rn_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb32rn_32lop2:
	movzx eax,byte [ecx]
	mov ah,0xff
	shl eax,16
	mov ah,byte [ecx+1]
	mov al,byte [ecx+2]
	lea ecx,[ecx+4]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec ebx
	jnz cargb32rn_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb32rn_32lop
	pop ebx
	ret

;void ImageUtil_ConvARGB48_32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvARGB48_32:
ImageUtil_ConvARGB48_32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx+ebx*2]
	shl eax,1
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb48_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb48_32lop2:
	movzx eax,byte [ecx+5]
	or eax,0xff00
	shl eax,16
	mov ah,byte [ecx+3]
	mov al,byte [ecx+1]
	lea ecx,[ecx+6]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec ebx
	jnz cargb48_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb48_32lop
	pop ebx
	ret

;void ImageUtil_ConvARGB64_32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvARGB64_32:
ImageUtil_ConvARGB64_32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*8]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb64_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb64_32lop2:
	movq xmm0,[ecx]
	psrlw xmm0,8
	lea ecx,[ecx+8]
	packuswb xmm0,xmm0
	movd dword [edx],xmm0
	lea edx,[edx+4]
	dec ebx
	jnz cargb64_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb64_32lop
	pop ebx
	ret

;void ImageUtil_ConvA2B10G10R10_32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvA2B10G10R10_32:
ImageUtil_ConvA2B10G10R10_32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	
	align 16
ca2b10g10r10_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
ca2b10g10r10_32lop2:
	mov eax,dword [ecx]
	shr eax,2
	mov byte [edx+2],al
	shr eax,10
	mov byte [edx+1],al
	shr eax,10
	mov byte [edx+0],al
	mov al,ah
	shl al,2
	or al,ah
	mov ah,al
	shl al,4
	or al,ah
	mov byte [edx+3],al
	lea ecx,[ecx+4]
	lea edx,[edx+4]
	dec ebx
	jnz ca2b10g10r10_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz ca2b10g10r10_32lop
	pop ebx
	ret

;void ImageUtil_ConvFB32G32R32A32_32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvFB32G32R32A32_32:
ImageUtil_ConvFB32G32R32A32_32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	lea eax,[eax*4]
	sub dword [esp+24],eax ;sbpl
	mov eax,255
	cvtsi2ss xmm1,eax
	unpcklps xmm1,xmm1
	unpcklps xmm1,xmm1
	
	align 16
cfb32g32r32a32_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cfb32g32r32a32_32lop2:
	movups xmm0,[ecx]
	mulps xmm0,xmm1
	cvtps2dq xmm0,xmm0
	packssdw xmm0,xmm0
	packuswb xmm0,xmm0
	movd [edx],xmm0
	lea ecx,[ecx+16]
	lea edx,[edx+4]
	dec ebx
	jnz cfb32g32r32a32_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cfb32g32r32a32_32lop
	pop ebx
	ret
	
;void ImageUtil_ConvFB32G32R32_32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvFB32G32R32_32:
ImageUtil_ConvFB32G32R32_32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	lea eax,[eax*2+eax]
	sub dword [esp+24],eax ;sbpl
	mov eax,255
	cvtsi2ss xmm1,eax
	unpcklps xmm1,xmm1
	unpcklps xmm1,xmm1
	
	align 16
cfb32g32r32_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cfb32g32r32_32lop2:
	movq xmm0,[ecx]
	movss xmm2,[ecx+8]
	punpcklqdq xmm0,xmm2
	mulps xmm0,xmm1
	cvtps2dq xmm0,xmm0
	packssdw xmm0,xmm0
	packuswb xmm0,xmm0
	movd [edx],xmm0
	mov byte [edx+3],0xff
	lea ecx,[ecx+12]
	lea edx,[edx+4]
	dec ebx
	jnz cfb32g32r32_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cfb32g32r32_32lop
	pop ebx
	ret

;void ImageUtil_ConvFW32A32_32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvFW32A32_32:
ImageUtil_ConvFW32A32_32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;dbpl
	lea eax,[eax*2]
	sub dword [esp+24],eax ;sbpl
	mov eax,255
	cvtsi2ss xmm1,eax
	unpcklps xmm1,xmm1
	unpcklps xmm1,xmm1
	
	align 16
cfw32a32_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cfw32a32_32lop2:
	movq xmm0,[ecx]
	mulps xmm0,xmm1
	cvtps2dq xmm0,xmm0
	packssdw xmm0,xmm0
	packuswb xmm0,xmm0
	movd eax,xmm0
	mov byte [edx],al
	mov byte [edx+1],al
	mov word [edx+2],ax
	lea ecx,[ecx+8]
	lea edx,[edx+4]
	dec ebx
	jnz cfw32a32_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cfw32a32_32lop
	pop ebx
	ret

;void ImageUtil_ConvFW32_32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvFW32_32:
ImageUtil_ConvFW32_32:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+24],eax ;sbpl
	sub dword [esp+28],eax ;dbpl
	mov eax,255
	cvtsi2ss xmm1,eax
	unpcklps xmm1,xmm1
	unpcklps xmm1,xmm1
	
	align 16
cfw32_32lop:
	mov ebx,dword [esp+16] ;w
	align 16
cfw32_32lop2:
	movss xmm0,[ecx]
	mulss xmm0,xmm1
	cvtps2dq xmm0,xmm0
	packssdw xmm0,xmm0
	packuswb xmm0,xmm0
	movd eax,xmm0
	mov byte [edx],al
	mov byte [edx+1],al
	mov byte [edx+2],al
	mov byte [edx+3],0xff
	lea ecx,[ecx+4]
	lea edx,[edx+4]
	dec ebx
	jnz cfw32_32lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cfw32_32lop
	pop ebx
	ret

;void ImageUtil_ConvP1_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP1_ARGB64:
ImageUtil_ConvP1_ARGB64:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr
	mov edx,dword [esp+20] ;destPtr
	mov ebx,dword [esp+24] ;w
	test ebx,7
	jnz cargb1_64lop
	
	lea eax,[ebx*8]
	shr dword [esp+24],3 ;w
	shr ebx,3
	sub dword [esp+32],ebx ;sbpl
	sub dword [esp+36],eax ;dbpl
	align 16
cargb1_64lop2:
	mov ebx,dword [esp+24] ;w
	align 16
cargb1_64lop3:
	movzx eax,byte [ecx]
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+8],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+16],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+24],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+32],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+40],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+48],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+56],xmm0
	lea ecx,[ecx+1]
	lea edx,[edx+64]
	dec ebx
	jnz cargb1_64lop3
	
	add ecx,dword [esp+32] ;sbpl
	add edx,dword [esp+36] ;dbpl
	dec dword [esp+28] ;h
	jnz cargb1_64lop2
	jmp cargb1_64exit
	
	align 16
cargb1_64lop:
	lea eax,[ebx*8]
	shr ebx,3
	sub dword [esp+32],ebx ;sbpl
	sub dword [esp+36],eax ;dbpl
	align 16
cargb1_64lop4:
	mov ebx,dword [esp+24] ;w
	shr ebx,3
	jz cargb1_64lop7
	align 16
cargb1_64lop5:
	movzx eax,byte [ecx]
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+8],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+16],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+24],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+32],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+40],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+48],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+56],xmm0
	lea ecx,[ecx+1]
	lea edx,[edx+64]
	dec ebx
	jnz cargb1_64lop5

	align 16
cargb1_64lop7:
	mov ebx,dword [esp+24] ;w
	movzx eax,byte [ecx]
	and ebx,7
	align 16
cargb1_64lop6:
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cargb1_64lop6
	
	add ecx,dword [esp+32] ;sbpl
	add edx,dword [esp+36] ;dbpl
	dec dword [esp+28] ;h
	jnz cargb1_64lop4

	align 16
cargb1_64exit:
	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP2_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP2_ARGB64:
ImageUtil_ConvP2_ARGB64:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr
	mov edx,dword [esp+20] ;destPtr
	mov ebx,dword [esp+24] ;w
	test ebx,3
	jnz cargb2_64lop
	
	lea eax,[ebx*8]
	shr dword [esp+24],2 ;w
	shr ebx,2
	sub dword [esp+32],ebx ;sbpl
	sub dword [esp+36],eax ;dbpl
	align 16
cargb2_64lop2:
	mov ebx,dword [esp+24] ;w
	align 16
cargb2_64lop3:
	movzx eax,byte [ecx]
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+8],xmm0
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+16],xmm0
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+24],xmm0
	lea ecx,[ecx+1]
	lea edx,[edx+32]
	dec ebx
	jnz cargb2_64lop3
	
	add ecx,dword [esp+32] ;sbpl
	add edx,dword [esp+36] ;dbpl
	dec dword [esp+28] ;h
	jnz cargb2_64lop2
	jmp cargb2_64exit
	
	align 16
cargb2_64lop:
	lea eax,[ebx*8]
	shr ebx,2
	sub dword [esp+32],ebx ;sbpl
	sub dword [esp+36],eax ;dbpl
	align 16
cargb2_64lop4:
	mov ebx,dword [esp+24] ;w
	shr ebx,2
	jz cargb2_64lop7
	align 16
cargb2_64lop5:
	movzx eax,byte [ecx]
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+8],xmm0
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+16],xmm0
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+24],xmm0
	lea ecx,[ecx+1]
	lea edx,[edx+32]
	dec ebx
	jnz cargb2_64lop5

	align 16
cargb2_64lop7:
	mov ebx,dword [esp+24] ;w
	movzx eax,byte [ecx]
	and ebx,3
	align 16
cargb2_64lop6:
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cargb2_64lop6
	
	add ecx,dword [esp+32] ;sbpl
	add edx,dword [esp+36] ;dbpl
	dec dword [esp+28] ;h
	jnz cargb2_64lop4

	align 16
cargb2_64exit:
	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP4_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 esi
;4 ebx
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
;36 pal esi
	align 16
_ImageUtil_ConvP4_ARGB64:
ImageUtil_ConvP4_ARGB64:
	push ebx
	push esi
	mov esi,dword [esp+36] ;pal
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	mov ebx,dword [esp+20] ;w
	shr dword [esp+20],1 ;w
	jb cargb4_32lop
	
	lea eax,[ebx*8]
	shr ebx,1
	sub dword [esp+28],ebx ;sbpl
	sub dword [esp+32],eax ;dbpl
	align 16
cargb4_64lop2:
	mov ebx,dword [esp+20] ;w
	align 16
cargb4_64lop3:
	movzx eax,byte [ecx]
	shr eax,4
	movd xmm0,dword [esi+eax*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	movzx eax,byte [ecx]
	and eax,15
	movd xmm0,dword [esi+eax*4]
	punpcklbw xmm0,xmm0
	lea ecx,[ecx+1]
	movq [edx+8],xmm0
	lea edx,[edx+16]
	dec ebx
	jnz cargb4_64lop3
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cargb4_64lop2
	jmp cargb4_64exit
	
	align 16
cargb4_64lop:
	lea eax,[ebx*8]
	shr ebx,1
	sub dword [esp+28],ebx ;sbpl
	sub dword [esp+32],eax ;dbpl
	align 16
cargb4_64lop4:
	mov ebx,dword [esp+20] ;w
	test ebx,ebx
	jz cargb4_64lop7
	align 16
cargb4_64lop5:
	movzx eax,byte [ecx]
	shr eax,4
	movd xmm0,dword [esi+eax*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	movzx eax,byte [ecx]
	and eax,15
	movd xmm0,dword [esi+eax*4]
	punpcklbw xmm0,xmm0
	lea ecx,[ecx+1]
	movq [edx+8],xmm0
	lea edx,[edx+16]
	dec ebx
	jnz cargb4_64lop5

	align 16
cargb4_64lop7:
	movzx eax,byte [ecx]
	shr eax,4
	movd xmm0,dword [esi+eax*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cargb4_64lop4

	align 16
cargb4_64exit:
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP8_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 esi
;4 ebx
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
;36 pal

	align 16
_ImageUtil_ConvP8_ARGB64:
ImageUtil_ConvP8_ARGB64:
	push ebx
	push esi
	mov esi,dword [esp+36] ;pal
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	
	mov ebx,dword [esp+20] ;w
	lea eax,[ebx*8]
	sub dword [esp+28],ebx ;sbpl
	sub dword [esp+32],eax ;dbpl
	align 16
cargb8_64lop:
	mov ebx,dword [esp+20] ;w
	align 16
cargb8_64lop2:
	movzx eax,byte [ecx]
	movd xmm0,dword [esi+eax*4]
	lea ecx,[ecx+1]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cargb8_64lop2
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cargb8_64lop
	
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP1_A1_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP1_A1_ARGB64:
ImageUtil_ConvP1_A1_ARGB64:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr

	align 16
cp1_a1_64lop2:
	mov ebx,dword [esp+24] ;w
	mov edx,dword [esp+20] ;destPtr
	shr ebx,3
	align 16
cp1_a1_64lop3:
	movzx eax,byte [ecx]
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+8],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+16],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+24],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+32],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+40],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+48],xmm0
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+56],xmm0
	lea ecx,[ecx+1]
	lea edx,[edx+64]
	dec ebx
	jnz cp1_a1_64lop3
	
	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp1_a1_64lop3b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp1_a1_64lop3a:
	rol al,1
	mov edi,eax
	and edi,1
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cp1_a1_64lop3a
	align 16
cp1_a1_64lop3b:
	
	mov ebx,dword [esp+24] ;w
	mov edi,dword [esp+20] ;destPtr
	shr ebx,3
	
	align 16
cp1_a1_64lop4:
	movzx eax,byte [ecx]
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+6],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+14],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+22],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+30],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+38],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+46],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+54],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+62],dx
	lea ecx,[ecx+1]
	lea edi,[edi+64]
	dec ebx
	jnz cp1_a1_64lop4
	
	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp1_a1_64lop4b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp1_a1_64lop4a:
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+6],dx
	lea edi,[edi+8]
	dec ebx
	jnz cp1_a1_64lop4a
	align 16
cp1_a1_64lop4b:

	mov eax,dword [esp+36] ;dbpl
	add dword [esp+20],eax ;destPtr
	dec dword [esp+28] ;h
	jnz cp1_a1_64lop2

	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP2_A1_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP2_A1_ARGB64:
ImageUtil_ConvP2_A1_ARGB64:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr

	align 16
cp2_a1_64lop2:
	mov ebx,dword [esp+24] ;w
	mov edx,dword [esp+20] ;destPtr
	shr ebx,2
	align 16
cp2_a1_64lop3:
	movzx eax,byte [ecx]
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+8],xmm0
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+16],xmm0
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx+24],xmm0
	lea ecx,[ecx+1]
	lea edx,[edx+32]
	dec ebx
	jnz cp2_a1_64lop3
	
	mov ebx,dword [esp+24] ;w
	and ebx,3
	jz cp2_a1_64lop3b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp2_a1_64lop3a:
	rol al,2
	mov edi,eax
	and edi,3
	movd xmm0,dword [esi+edi*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cp2_a1_64lop3a
	align 16
cp2_a1_64lop3b:
	
	mov ebx,dword [esp+24] ;w
	mov edi,dword [esp+20] ;destPtr
	shr ebx,3
	
	align 16
cp2_a1_64lop4:
	movzx eax,byte [ecx]
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+6],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+14],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+22],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+30],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+38],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+46],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+54],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+62],dx
	lea ecx,[ecx+1]
	lea edi,[edi+64]
	dec ebx
	jnz cp2_a1_64lop4

	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp2_a1_64lop4b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp2_a1_64lop4a:
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+6],dx
	lea edi,[edi+8]
	dec ebx
	jnz cp2_a1_64lop4a
	align 16
cp2_a1_64lop4b:

	mov eax,dword [esp+36] ;dbpl
	add dword [esp+20],eax ;destPtr
	dec dword [esp+28] ;h
	jnz cp2_a1_64lop2

	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP4_A1_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal esi
	align 16
_ImageUtil_ConvP4_A1_ARGB64:
ImageUtil_ConvP4_A1_ARGB64:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr

	align 16
cp4_a1_64lop2:
	mov ebx,dword [esp+24] ;w
	mov edx,dword [esp+20] ;destPtr
	shr ebx,1
	align 16
cp4_a1_64lop3:
	movzx eax,byte [ecx]
	shr eax,4
	movd xmm0,dword [esi+eax*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	movzx eax,byte [ecx]
	and eax,15
	movd xmm0,dword [esi+eax*4]
	punpcklbw xmm0,xmm0
	lea ecx,[ecx+1]
	movq [edx+8],xmm0
	lea edx,[edx+16]
	dec ebx
	jnz cp4_a1_64lop3
	
	test dword [esp+24],1 ;w
	jz cp4_a1_64lop3b
	movzx eax,byte [ecx]
	shr eax,4
	movd xmm0,dword [esi+eax*4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea ecx,[ecx+1]
	lea edx,[edx+8]
	align 16
cp4_a1_64lop3b:
	
	mov ebx,dword [esp+24] ;w
	mov edi,dword [esp+20] ;destPtr
	shr ebx,3
	
	align 16
cp4_a1_64lop4:
	movzx eax,byte [ecx]
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+6],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+14],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+22],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+30],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+38],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+46],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+54],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+62],dx
	lea ecx,[ecx+1]
	lea edi,[edi+64]
	dec ebx
	jnz cp4_a1_64lop4

	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp4_a1_64lop4b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp4_a1_64lop4a:
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+6],dx
	lea edi,[edi+8]
	dec ebx
	jnz cp4_a1_64lop4a
	align 16
cp4_a1_64lop4b:

	mov eax,dword [esp+36] ;dbpl
	add dword [esp+20],eax ;destPtr
	dec dword [esp+28] ;h
	jnz cp4_a1_64lop2

	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvP8_A1_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl, UInt8 *pal);
;0 edi
;4 esi
;8 ebx
;12 retAddr
;16 srcPtr
;20 destPtr
;24 w
;28 h
;32 sbpl
;36 dbpl
;40 pal

	align 16
_ImageUtil_ConvP8_A1_ARGB64:
ImageUtil_ConvP8_A1_ARGB64:
	push ebx
	push esi
	push edi
	mov esi,dword [esp+40] ;pal
	mov ecx,dword [esp+16] ;srcPtr

	align 16
cp8_a1_64lop:
	mov ebx,dword [esp+24] ;w
	mov edx,dword [esp+20] ;destPtr
	align 16
cp8_a1_64lop2:
	movzx eax,byte [ecx]
	movd xmm0,dword [esi+eax*4]
	lea ecx,[ecx+1]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cp8_a1_64lop2

	mov ebx,dword [esp+24] ;w
	mov edi,dword [esp+20] ;destPtr
	shr ebx,3
	
	align 16
cp8_a1_64lop4:
	movzx eax,byte [ecx]
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+6],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+14],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+22],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+30],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+38],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+46],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+54],dx
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+62],dx
	lea ecx,[ecx+1]
	lea edi,[edi+64]
	dec ebx
	jnz cp8_a1_64lop4
	
	mov ebx,dword [esp+24] ;w
	and ebx,7
	jz cp8_a1_64lop4b
	movzx eax,byte [ecx]
	lea ecx,[ecx+1]
	align 16
cp8_a1_64lop4a:
	rol al,1
	mov edx,eax
	and edx,1
	neg dx
	mov word [edi+6],dx
	lea edi,[edi+8]
	dec ebx
	jnz cp8_a1_64lop4a
	align 16
cp8_a1_64lop4b:

	mov eax,dword [esp+36] ;dbpl
	add dword [esp+20],eax ;destPtr
	dec dword [esp+28] ;h
	jnz cp8_a1_64lop
	
	pop edi
	pop esi
	pop ebx
	ret

;void ImageUtil_ConvB5G5R5_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl

	align 16
_ImageUtil_ConvB5G5R5_ARGB64:
ImageUtil_ConvB5G5R5_ARGB64:
	push ebx
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*2]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	mov eax,0x08420842
	movd xmm2,eax
	pxor xmm1,xmm1
	punpckldq xmm2,xmm2
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr

	align 16
cb5g5r5_64lop:
	mov ebx,dword [esp+16] ;w
	
	align 16
cb5g5r5_64lop2:
	movzx eax,word [ecx]
	and eax,0x7fff
	shl eax,6
	shr ax,3
	shr al,3
	movd xmm0, eax
	punpcklbw xmm0,xmm1
	pmullw xmm0, xmm2
	movq [edx],xmm0
	mov word [edx+6],0xffff

	lea ecx,[ecx+2]
	lea edx,[edx+8]
	dec ebx
	jnz cb5g5r5_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cb5g5r5_64lop
	pop ebx
	ret

;void ImageUtil_ConvB5G6R5_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl

	align 16
_ImageUtil_ConvB5G6R5_ARGB64:
ImageUtil_ConvB5G6R5_ARGB64:
	push ebx
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*2]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	mov eax,0x04100842
	movd xmm2,eax
	pxor xmm1,xmm1
	punpckldq xmm2,xmm2
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr

	align 16
cb5g6r5_64lop:
	mov ebx,dword [esp+16] ;w
	
	align 16
cb5g6r5_64lop2:
	movzx eax,word [ecx]
	shl eax,5
	shr ax,2
	shr al,3
	movd xmm0, eax
	punpcklbw xmm0,xmm1
	pmullw xmm0, xmm2
	movq [edx],xmm0
	mov word [edx+6],0xffff

	lea ecx,[ecx+2]
	lea edx,[edx+8]
	dec ebx
	jnz cb5g6r5_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cb5g6r5_64lop
	pop ebx
	ret

;void ImageUtil_ConvB8G8R8_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvB8G8R8_ARGB64:
ImageUtil_ConvB8G8R8_ARGB64:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx+ebx*2]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb24_64lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb24_64lop2:
	movzx eax,byte [ecx+2]
	or eax,0xff00
	shl eax,16
	mov ax,word [ecx]
	lea ecx,[ecx+3]
	movd xmm0,eax
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cargb24_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb24_64lop
	pop ebx
	ret
	
;void ImageUtil_ConvR8G8B8_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvR8G8B8_ARGB64:
ImageUtil_ConvR8G8B8_ARGB64:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx+ebx*2]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb24r_64lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb24r_64lop2:
	movzx eax,byte [ecx]
	or eax,0xff00
	shl eax,16
	mov ah,byte [ecx+1]
	mov al,byte [ecx+2]
	lea ecx,[ecx+3]
	movd xmm0,eax
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cargb24r_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb24r_64lop
	pop ebx
	ret

;void ImageUtil_ConvR8G8B8A8_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvR8G8B8A8_ARGB64:
ImageUtil_ConvR8G8B8A8_ARGB64:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb32r_64lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb32r_64lop2:
	movzx eax,byte [ecx]
	mov ah,byte [ecx+3]
	shl eax,16
	mov ah,byte [ecx+1]
	mov al,byte [ecx+2]
	lea ecx,[ecx+4]
	movd xmm0,eax
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cargb32r_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb32r_64lop
	pop ebx
	ret

;void ImageUtil_ConvARGB32_64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvARGB32_64:
ImageUtil_ConvARGB32_64:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb32_64lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb32_64lop2:
	movd xmm0,[ecx]
	lea ecx,[ecx+4]
	punpcklbw xmm0,xmm0
	movq [edx],xmm0
	lea edx,[edx+8]
	dec ebx
	jnz cargb32_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb32_64lop
	pop ebx
	ret

;void ImageUtil_ConvARGB48_64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvARGB48_64:
ImageUtil_ConvARGB48_64:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx+ebx*2]
	shl eax,1
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	
	align 16
cargb48_64lop:
	mov ebx,dword [esp+16] ;w
	align 16
cargb48_64lop2:
	mov eax,dword [ecx]
	movnti dword [edx],eax
	mov ax,word [ecx+4]
	or eax,0xffff0000
	lea ecx,[ecx+6]
	movnti dword [edx+4],eax
	lea edx,[edx+8]
	dec ebx
	jnz cargb48_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cargb48_64lop
	pop ebx
	ret

;void ImageUtil_ConvA2B10G10R10_64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 edi
;4 ebx
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_ConvA2B10G10R10_64:
ImageUtil_ConvA2B10G10R10_64:
	push ebx
	push edi
	mov ecx,dword [esp+12] ;srcPtr
	mov edi,dword [esp+16] ;destPtr
	mov ebx,dword [esp+20] ;w
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+32],eax ;dbpl
	
	align 16
ca2b10g10r10_64lop:
	mov ebx,dword [esp+20] ;w
	align 16
ca2b10g10r10_64lop2:
	mov eax,dword [ecx]
	mov edx,eax
	shl eax,6
	shr edx,4
	and dx,0x3f
	or ax,dx
	mov word [edi+4],ax
	mov ax,0
	shr eax,10
	mov dx,ax
	shr dx,10
	or ax,dx
	mov word [edi+2],ax
	shr edx,10
	mov ax,dx
	shr dx,10
	or ax,dx
	mov word [edi+0],ax
	mov dx,0
	shr edx,2
	mov eax,edx
	shr edx,2
	or ax,dx
	mov dx,ax
	shr dx,4
	or ax,dx
	mov al,ah
	mov word [edi+6],ax
	lea ecx,[ecx+4]
	lea edi,[edi+8]
	dec ebx
	jnz ca2b10g10r10_64lop2
	
	add ecx,dword [esp+28] ;sbpl
	add edi,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz ca2b10g10r10_64lop
	pop edi
	pop ebx
	ret

;void ImageUtil_ConvFB32G32R32A32_64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvFB32G32R32A32_64:
ImageUtil_ConvFB32G32R32A32_64:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	lea eax,[eax*2]
	sub dword [esp+24],eax ;sbpl
	mov eax,65535
	cvtsi2ss xmm1,eax
	mov eax,32768
	movd xmm2,eax
	unpcklps xmm1,xmm1
	unpcklps xmm1,xmm1
	punpckldq xmm2,xmm2
	punpckldq xmm2,xmm2
	movdqa xmm3,xmm2
	pslld xmm3,16
	por xmm3,xmm2
	
	align 16
cfb32g32r32a32_64lop:
	mov ebx,dword [esp+16] ;w
	align 16
cfb32g32r32a32_64lop2:
	movups xmm0,[ecx]
	mulps xmm0,xmm1
	cvtps2dq xmm0,xmm0
	psubd xmm0,xmm2
	packssdw xmm0,xmm0
	paddw xmm0,xmm3
	movq [edx],xmm0
	lea ecx,[ecx+16]
	lea edx,[edx+8]
	dec ebx
	jnz cfb32g32r32a32_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cfb32g32r32a32_64lop
	pop ebx
	ret
	
;void ImageUtil_ConvFB32G32R32_64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvFB32G32R32_64:
ImageUtil_ConvFB32G32R32_64:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	lea eax,[ebx*4+eax]
	sub dword [esp+24],eax ;sbpl
	mov eax,65535
	cvtsi2ss xmm1,eax
	mov eax,32768
	movd xmm2,eax
	unpcklps xmm1,xmm1
	unpcklps xmm1,xmm1
	punpckldq xmm2,xmm2
	punpckldq xmm2,xmm2
	movdqa xmm3,xmm2
	pslld xmm3,16
	por xmm3,xmm2
	
	align 16
cfb32g32r32_64lop:
	mov ebx,dword [esp+16] ;w
	align 16
cfb32g32r32_64lop2:
	movq xmm0,[ecx]
	movss xmm4,[ecx+8]
	punpcklqdq xmm0,xmm4
	mulps xmm0,xmm1
	cvtps2dq xmm0,xmm0
	psubd xmm0,xmm2
	packssdw xmm0,xmm0
	paddw xmm0,xmm3
	movq [edx],xmm0
	mov word [edx+6],0xffff
	lea ecx,[ecx+12]
	lea edx,[edx+8]
	dec ebx
	jnz cfb32g32r32_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cfb32g32r32_64lop
	pop ebx
	ret

;void ImageUtil_ConvFW32A32_64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvFW32A32_64:
ImageUtil_ConvFW32A32_64:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	sub dword [esp+24],eax ;sbpl
	mov eax,65535
	cvtsi2ss xmm1,eax
	mov eax,32768
	movd xmm2,eax
	unpcklps xmm1,xmm1
	unpcklps xmm1,xmm1
	punpckldq xmm2,xmm2
	punpckldq xmm2,xmm2
	movdqa xmm3,xmm2
	pslld xmm3,16
	por xmm3,xmm2
	
	align 16
cfw32a32_64lop:
	mov ebx,dword [esp+16] ;w
	align 16
cfw32a32_64lop2:
	movq xmm0,[ecx]
	mulps xmm0,xmm1
	cvtps2dq xmm0,xmm0
	psubd xmm0,xmm2
	packssdw xmm0,xmm0
	paddw xmm0,xmm3
	movd eax,xmm0
	mov word [edx],ax
	mov word [edx+2],ax
	mov dword [edx+4],eax
	lea ecx,[ecx+8]
	lea edx,[edx+8]
	dec ebx
	jnz cfw32a32_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cfw32a32_64lop
	pop ebx
	ret

;void ImageUtil_ConvFW32_64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 retAddr
;8 srcPtr
;12 destPtr
;16 w
;20 h
;24 sbpl
;28 dbpl
	align 16
_ImageUtil_ConvFW32_64:
ImageUtil_ConvFW32_64:
	push ebx
	mov ecx,dword [esp+8] ;srcPtr
	mov edx,dword [esp+12] ;destPtr
	mov ebx,dword [esp+16] ;w
	lea eax,[ebx*4]
	sub dword [esp+24],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+28],eax ;dbpl
	mov eax,65535
	cvtsi2ss xmm1,eax
	mov eax,32768
	movd xmm2,eax
	unpcklps xmm1,xmm1
	unpcklps xmm1,xmm1
	punpckldq xmm2,xmm2
	punpckldq xmm2,xmm2
	movdqa xmm3,xmm2
	pslld xmm3,16
	por xmm3,xmm2
	
	align 16
cfw32_64lop:
	mov ebx,dword [esp+16] ;w
	align 16
cfw32_64lop2:
	movss xmm0,[ecx]
	mulps xmm0,xmm1
	cvtps2dq xmm0,xmm0
	psubd xmm0,xmm2
	packssdw xmm0,xmm0
	paddw xmm0,xmm3
	movd eax,xmm0
	mov word [edx],ax
	mov word [edx+2],ax
	mov word [edx+4],ax
	mov word [edx+6],0xffff
	lea ecx,[ecx+4]
	lea edx,[edx+8]
	dec ebx
	jnz cfw32_64lop2
	
	add ecx,dword [esp+24] ;sbpl
	add edx,dword [esp+28] ;dbpl
	dec dword [esp+20] ;h
	jnz cfw32_64lop
	pop ebx
	ret

;void ImageUtil_ConvW16_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_ConvW16_ARGB32:
ImageUtil_ConvW16_ARGB32:
	push esi
	push ebx
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	mov ebx,dword [esp+20] ;w
	lea eax,[ebx*2]
	sub dword [esp+28],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+32],eax ;dbpl
	
	align 16
cw16_argb32lop:
	mov esi,dword [esp+20] ;w
	align 16
cw16_argb32lop2:
	movzx eax,byte [ecx+1]
	mov bl,al
	or eax,0xff00
	shl eax,16
	mov ah,bl
	mov al,bl
	lea ecx,[ecx+2]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec esi
	jnz cw16_argb32lop2
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cw16_argb32lop
	pop ebx
	pop esi
	ret
	
;void ImageUtil_ConvW16A16_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_ConvW16A16_ARGB32:
ImageUtil_ConvW16A16_ARGB32:
	push esi
	push ebx
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	mov ebx,dword [esp+20] ;w
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+32],eax ;dbpl
	
	align 16
cw16a16_argb32lop:
	mov esi,dword [esp+20] ;w
	align 16
cw16a16_argb32lop2:
	movzx eax,byte [ecx+1]
	mov bl,al
	mov ah,byte [ecx+3]
	shl eax,16
	mov ah,bl
	mov al,bl
	lea ecx,[ecx+4]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec esi
	jnz cw16a16_argb32lop2
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cw16a16_argb32lop
	pop ebx
	pop esi
	ret
	
;void ImageUtil_ConvW8A8_ARGB32(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_ConvW8A8_ARGB32:
ImageUtil_ConvW8A8_ARGB32:
	push esi
	push ebx
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	mov ebx,dword [esp+20] ;w
	lea eax,[ebx*2]
	sub dword [esp+28],eax ;sbpl
	lea eax,[ebx*4]
	sub dword [esp+32],eax ;dbpl
	
	align 16
cw8a8_argb32lop:
	mov esi,dword [esp+20] ;w
	align 16
cw8a8_argb32lop2:
	mov ax,word [ecx]
	mov bl,al
	shl eax,16
	mov ah,bl
	mov al,bl
	lea ecx,[ecx+2]
	movnti dword [edx],eax
	lea edx,[edx+4]
	dec esi
	jnz cw8a8_argb32lop2
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cw8a8_argb32lop
	pop ebx
	pop esi
	ret
	
;void ImageUtil_ConvW16_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_ConvW16_ARGB64:
ImageUtil_ConvW16_ARGB64:
	push esi
	push ebx
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	mov ebx,dword [esp+20] ;w
	lea eax,[ebx*2]
	sub dword [esp+28],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+32],eax ;dbpl
	
	align 16
cw16_argb64lop:
	mov esi,dword [esp+20] ;w
	align 16
cw16_argb64lop2:
	mov ax,word [ecx]
	or eax,0xffff0000
	mov word [edx],ax
	mov word [edx+2],ax
	mov dword [edx+4],eax
	lea ecx,[ecx+2]
	lea edx,[edx+8]
	dec esi
	jnz cw16_argb64lop2
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cw16_argb64lop
	pop ebx
	pop esi
	ret
	
;void ImageUtil_ConvW16A16_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_ConvW16A16_ARGB64:
ImageUtil_ConvW16A16_ARGB64:
	push esi
	push ebx
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	mov ebx,dword [esp+20] ;w
	lea eax,[ebx*4]
	sub dword [esp+28],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+32],eax ;dbpl
	
	align 16
cw16a16_argb64lop:
	mov esi,dword [esp+20] ;w
	align 16
cw16a16_argb64lop2:
	mov eax,dword [ecx]
	mov word [edx+0],ax
	mov word [edx+2],ax
	mov dword [edx+4],eax
	lea ecx,[ecx+4]
	lea edx,[edx+8]
	dec esi
	jnz cw16a16_argb64lop2
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cw16a16_argb64lop
	pop ebx
	pop esi
	ret
	
;void ImageUtil_ConvW8A8_ARGB64(UInt8 *srcPtr, UInt8 *destPtr, OSInt w, OSInt h, OSInt sbpl, OSInt dbpl);
;0 ebx
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 w
;24 h
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_ConvW8A8_ARGB64:
ImageUtil_ConvW8A8_ARGB64:
	push esi
	push ebx
	mov ecx,dword [esp+12] ;srcPtr
	mov edx,dword [esp+16] ;destPtr
	mov ebx,dword [esp+20] ;w
	lea eax,[ebx*2]
	sub dword [esp+28],eax ;sbpl
	lea eax,[ebx*8]
	sub dword [esp+32],eax ;dbpl
	
	align 16
cw8a8_argb64lop:
	mov esi,dword [esp+20] ;w
	align 16
cw8a8_argb64lop2:
	mov al,byte [ecx+1]
	mov ah,al
	shl eax,16
	mov al,byte [ecx]
	mov ah,al
	mov word [edx+0],ax
	mov word [edx+2],ax
	mov dword [edx+4],eax
	lea ecx,[ecx+2]
	lea edx,[edx+8]
	dec esi
	jnz cw8a8_argb64lop2
	
	add ecx,dword [esp+28] ;sbpl
	add edx,dword [esp+32] ;dbpl
	dec dword [esp+24] ;h
	jnz cw8a8_argb64lop
	pop ebx
	pop esi
	ret
	
;void ImageUtil_Rotate32_CW90(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_Rotate32_CW90:
ImageUtil_Rotate32_CW90:
	push esi
	push edi
	mov ecx,dword [esp+24] ;srcHeight
	mov eax,dword [esp+28] ;sbpl
	mul ecx ;srcHeight
	add dword [esp+12],eax ;srcPtr
	lea edx,[ecx*4]
	sub dword [esp+32],edx ;dbpl

	mov edi,dword [esp+16] ;destPtr
	mov edx,dword [esp+20] ;srcWidth
	
	align 16
r32cw90lop:
	mov ecx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	
	align 16
r32cw90lop2:
	sub esi,dword [esp+28] ;sbpl
	mov eax,dword [esi]
	mov dword [edi],eax
	lea edi,[edi+4]
	dec ecx
	jnz r32cw90lop2
	add dword [esp+12],4 ;srcPtr
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz r32cw90lop
	pop edi
	pop esi
	ret

;void ImageUtil_Rotate32_CW180(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_Rotate32_CW180:
ImageUtil_Rotate32_CW180:
	push esi
	push edi
	mov eax,dword [esp+28] ;sbpl
	mul dword [esp+24] ;srcHeight
	add dword [esp+12],eax ;srcPtr
	mov eax,dword [esp+20] ;srcWidth
	shl eax,2
	sub dword [esp+28],eax ;sbpl
	sub dword [esp+32],eax ;dbpl

	mov edx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	mov edi,dword [esp+16] ;destPtr
	
	align 16
r32cw180lop:
	mov ecx,dword [esp+20] ;srcWidth
	
	align 16
r32cw180lop2:
	lea esi,[esi-4]
	mov eax,dword [esi]
	mov dword [edi],eax
	lea edi,[edi+4]
	dec ecx
	jnz r32cw180lop2
	
	sub esi,dword [esp+28] ;sbpl
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz r32cw180lop
	
	pop edi
	pop esi
	ret

;void ImageUtil_Rotate32_CW270(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_Rotate32_CW270:
ImageUtil_Rotate32_CW270:
	push esi
	push edi
	mov eax,dword [esp+28] ;sbpl
	add dword [esp+12],eax ;srcPtr
	mov eax,dword [esp+24] ;srcHeight
	shl eax,2
	sub dword [esp+32],eax ;dbpl
	
	mov edx,dword [esp+20] ;srcWidth
	mov edi,dword [esp+16] ;destPtr
	align 16
r32cw270lop:
	sub dword [esp+12],4 ;srcPtr
	mov ecx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	
	align 16
r32cw270lop2:
	mov eax,dword [esi]
	mov dword [edi],eax
	add esi,dword [esp+28] ;sbpl
	lea edi,[edi+4]
	dec ecx
	jnz r32cw270lop2
	
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz r32cw270lop
	
	pop edi
	pop esi
	ret

;void ImageUtil_Rotate64_CW90(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_Rotate64_CW90:
ImageUtil_Rotate64_CW90:
	push esi
	push edi
	mov ecx,dword [esp+24] ;srcHeight
	mov eax,dword [esp+28] ;sbpl
	mul ecx ;srcHeight
	add dword [esp+12],eax ;srcPtr
	lea edx,[ecx*8]
	sub dword [esp+32],edx ;dbpl

	mov edi,dword [esp+16] ;destPtr
	mov edx,dword [esp+20] ;srcWidth
	
	align 16
r64cw90lop:
	mov ecx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	
	align 16
r64cw90lop2:
	sub esi,dword [esp+28] ;sbpl
	movq xmm0,[esi]
	movq [edi],xmm0
	lea edi,[edi+8]
	dec ecx
	jnz r64cw90lop2
	add dword [esp+12],8 ;srcPtr
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz r64cw90lop
	pop edi
	pop esi
	ret

;void ImageUtil_Rotate64_CW180(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_Rotate64_CW180:
ImageUtil_Rotate64_CW180:
	push esi
	push edi
	mov eax,dword [esp+28] ;sbpl
	mul dword [esp+24] ;srcHeight
	add dword [esp+12],eax ;srcPtr
	mov eax,dword [esp+20] ;srcWidth
	shl eax,3
	sub dword [esp+28],eax ;sbpl
	sub dword [esp+32],eax ;dbpl

	mov edx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	mov edi,dword [esp+16] ;destPtr
	
	align 16
r64cw180lop:
	mov ecx,dword [esp+20] ;srcWidth
	
	align 16
r64cw180lop2:
	lea esi,[esi-8]
	movq xmm0,[esi]
	movq [edi],xmm0
	lea edi,[edi+8]
	dec ecx
	jnz r64cw180lop2
	
	sub esi,dword [esp+28] ;sbpl
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz r64cw180lop
	
	pop edi
	pop esi
	ret

;void ImageUtil_Rotate64_CW270(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_Rotate64_CW270:
ImageUtil_Rotate64_CW270:
	push esi
	push edi
	mov eax,dword [esp+28] ;sbpl
	add dword [esp+12],eax ;srcPtr
	mov eax,dword [esp+24] ;srcHeight
	shl eax,3
	sub dword [esp+32],eax ;dbpl
	
	mov edx,dword [esp+20] ;srcWidth
	mov edi,dword [esp+16] ;destPtr
	align 16
r64cw270lop:
	sub dword [esp+12],8 ;srcPtr
	mov ecx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	
	align 16
r64cw270lop2:
	movq xmm0,[esi]
	movq [edi],xmm0
	add esi,dword [esp+28] ;sbpl
	lea edi,[edi+8]
	dec ecx
	jnz r64cw270lop2
	
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz r64cw270lop
	
	pop edi
	pop esi
	ret

;void ImageUtil_HFlip32(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl, Bool upsideDown);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
;36 upsideDown
	align 16
_ImageUtil_HFlip32:
ImageUtil_HFlip32:
	push esi
	push edi
	mov eax,dword [esp+28] ;sbpl
	add dword [esp+12],eax ;srcPtr
	cmp byte [esp+36],0
	jz hf32lop

	mov eax,dword [esp+32] ;dbpl
	neg eax
	mov dword [esp+32],eax ;dbpl
	mov edx,dword [esp+24] ;srcHeight
	dec edx
	imul eax,edx
	add dword [esp+16],eax ;destPtr
	align 16
hf32lop:
	mov eax,dword [esp+20] ;srcWidth
	shl eax,2
	sub dword [esp+32],eax ;dbpl
	
	mov ecx,dword [esp+24] ;srcHeight
	mov edi,dword [esp+16] ;destPtr
	mov esi,dword [esp+12] ;srcPtr
	align 16
hf32lop2:
	mov edx,dword [esp+20] ;srcWidth
	
	align 16
hf32lop3:
	dec edx
	mov eax,dword [esi+edx*4]
	mov [edi],eax
	lea edi,[edi+4]
	jnz hf32lop3
	
	add esi,dword [esp+28] ;sbpl
	add edi,dword [esp+32] ;dbpl
	dec ecx
	jnz hf32lop2
	
	pop edi
	pop esi
	ret

;void ImageUtil_HFRotate32_CW90(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_HFRotate32_CW90:
ImageUtil_HFRotate32_CW90:
	push esi
	push edi
	mov ecx,dword [esp+24] ;srcHeight
	mov eax,dword [esp+28] ;sbpl
	imul eax,ecx ;srcHeight
	lea edx,[ecx*4]
	sub dword [esp+32],edx ;dbpl
	mov ecx,dword [esp+20] ;srcWidth
	lea eax,[eax+ecx*4] ;srcPtr += sbpl * srcHeight + srcWidth * 4
	add dword [esp+12],eax ;srcPtr

	mov edi,dword [esp+16] ;destPtr
	mov edx,dword [esp+20] ;srcWidth
	
	align 16
hfr32cw90lop:
	sub dword [esp+12],4 ;srcPtr
	mov ecx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	
	align 16
hfr32cw90lop2:
	sub esi,dword [esp+28] ;sbpl
	mov eax,dword [esi]
	mov dword [edi],eax
	lea edi,[edi+4]
	dec ecx
	jnz hfr32cw90lop2
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz hfr32cw90lop
	pop edi
	pop esi
	ret

;void ImageUtil_HFRotate32_CW180(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_HFRotate32_CW180:
ImageUtil_HFRotate32_CW180:
	push esi
	push edi
	mov eax,dword [esp+28] ;sbpl
	mul dword [esp+24] ;srcHeight
	add dword [esp+12],eax ;srcPtr
	mov eax,dword [esp+20] ;srcWidth
	shl eax,2
	add dword [esp+28],eax ;sbpl
	sub dword [esp+32],eax ;dbpl
	add dword [esp+12],eax ;srcPtr

	mov edx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	mov edi,dword [esp+16] ;destPtr
	
	align 16
hfr32cw180lop:
	sub esi,dword [esp+28] ;sbpl
	mov ecx,dword [esp+20] ;srcWidth
	rep movsd
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz hfr32cw180lop
	
	pop edi
	pop esi
	ret

;void ImageUtil_HFRotate32_CW270(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_HFRotate32_CW270:
ImageUtil_HFRotate32_CW270:
	push esi
	push edi
	mov eax,dword [esp+24] ;srcHeight
	shl eax,2
	sub dword [esp+32],eax ;dbpl
	
	mov edx,dword [esp+20] ;srcWidth
	mov edi,dword [esp+16] ;destPtr
	align 16
hfr32cw270lop:
	mov ecx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	
	align 16
hfr32cw270lop2:
	mov eax,dword [esi]
	mov dword [edi],eax
	add esi,dword [esp+28] ;sbpl
	lea edi,[edi+4]
	dec ecx
	jnz hfr32cw270lop2
	
	add dword [esp+12],4 ;srcPtr
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz hfr32cw270lop
	
	pop edi
	pop esi
	ret


;void ImageUtil_HFlip64(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl, Bool upsideDown);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
;36 upsideDown
	align 16
_ImageUtil_HFlip64:
ImageUtil_HFlip64:
	push esi
	push edi
	mov eax,dword [esp+28] ;sbpl
	add dword [esp+12],eax ;srcPtr
	cmp byte [esp+36],0
	jz hf64lop

	mov eax,dword [esp+32] ;dbpl
	neg eax
	mov dword [esp+32],eax ;dbpl
	mov edx,dword [esp+24] ;srcHeight
	dec edx
	imul eax,edx
	add dword [esp+16],eax ;destPtr
	align 16
hf64lop:
	mov eax,dword [esp+20] ;srcWidth
	shl eax,3
	sub dword [esp+32],eax ;dbpl
	
	mov ecx,dword [esp+24] ;srcHeight
	mov edi,dword [esp+16] ;destPtr
	mov esi,dword [esp+12] ;srcPtr
	align 16
hf64lop2:
	mov edx,dword [esp+20] ;srcWidth
	
	align 16
hf64lop3:
	dec edx
	movq xmm0,[esi+edx*8]
	movq [edi],xmm0
	lea edi,[edi+8]
	jnz hf64lop3
	
	add esi,dword [esp+28] ;sbpl
	add edi,dword [esp+32] ;dbpl
	dec ecx
	jnz hf64lop2
	
	pop edi
	pop esi
	ret

;void ImageUtil_HFRotate64_CW90(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_HFRotate64_CW90:
ImageUtil_HFRotate64_CW90:
	push esi
	push edi
	mov ecx,dword [esp+24] ;srcHeight
	mov eax,dword [esp+28] ;sbpl
	imul eax,ecx ;srcHeight
	lea edx,[ecx*8]
	sub dword [esp+32],edx ;dbpl
	mov ecx,dword [esp+20] ;srcWidth
	lea eax,[eax+ecx*8] ;srcPtr += sbpl * srcHeight + srcWidth * 4
	add dword [esp+12],eax ;srcPtr

	mov edi,dword [esp+16] ;destPtr
	mov edx,dword [esp+20] ;srcWidth
	
	align 16
hfr64cw90lop:
	sub dword [esp+12],8 ;srcPtr
	mov ecx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	
	align 16
hfr64cw90lop2:
	sub esi,dword [esp+28] ;sbpl
	mov eax,dword [esi]
	mov dword [edi],eax
	lea edi,[edi+8]
	dec ecx
	jnz hfr64cw90lop2
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz hfr64cw90lop
	pop edi
	pop esi
	ret

;void ImageUtil_HFRotate64_CW180(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_HFRotate64_CW180:
ImageUtil_HFRotate64_CW180:
	push esi
	push edi
	mov eax,dword [esp+28] ;sbpl
	mul dword [esp+24] ;srcHeight
	add dword [esp+12],eax ;srcPtr
	mov eax,dword [esp+20] ;srcWidth
	shl eax,3
	add dword [esp+28],eax ;sbpl
	sub dword [esp+32],eax ;dbpl
	add dword [esp+12],eax ;srcPtr

	mov edx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	mov edi,dword [esp+16] ;destPtr
	
	align 16
hfr64cw180lop:
	sub esi,dword [esp+28] ;sbpl
	mov ecx,dword [esp+20] ;srcWidth
	shl ecx,1
	rep movsd
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz hfr64cw180lop
	
	pop edi
	pop esi
	ret

;void ImageUtil_HFRotate64_CW270(UInt8 *srcPtr, UInt8 *destPtr, OSInt srcWidth, OSInt srcHeight, OSInt sbpl, OSInt dbpl);
;0 edi
;4 esi
;8 retAddr
;12 srcPtr
;16 destPtr
;20 srcWidth
;24 srcHeight
;28 sbpl
;32 dbpl
	align 16
_ImageUtil_HFRotate64_CW270:
ImageUtil_HFRotate64_CW270:
	push esi
	push edi
	mov eax,dword [esp+24] ;srcHeight
	shl eax,3
	sub dword [esp+32],eax ;dbpl
	
	mov edx,dword [esp+20] ;srcWidth
	mov edi,dword [esp+16] ;destPtr
	align 16
hfr64cw270lop:
	mov ecx,dword [esp+24] ;srcHeight
	mov esi,dword [esp+12] ;srcPtr
	
	align 16
hfr64cw270lop2:
	movq xmm0,[esi]
	movq [edi],xmm0
	add esi,dword [esp+28] ;sbpl
	lea edi,[edi+8]
	dec ecx
	jnz hfr64cw270lop2
	
	add dword [esp+12],8 ;srcPtr
	add edi,dword [esp+32] ;dbpl
	dec edx
	jnz hfr64cw270lop
	
	pop edi
	pop esi
	ret

;void ImageUtil_CopyShiftW(UInt8 *srcPtr, UInt8 *destPtr, OSInt byteSize, OSInt shiftCnt); //Assume aligned
;0 retAddr
;4 srcPtr
;8 destPtr
;12 byteSize
;16 shiftCnt
	align 16
_ImageUtil_CopyShiftW:
ImageUtil_CopyShiftW:
	mov ecx,dword [esp+4]
	mov edx,dword [esp+8]
	mov eax,dword [esp+12]
	shr eax,4
	cmp dword [esp+16],6
	jz cswlop6
	cmp dword [esp+16],4
	jz cswlop4
	cmp dword [esp+16],5
	jz cswlop5
	cmp dword [esp+16],3
	jz cswlop3
	cmp dword [esp+16],2
	jz cswlop2
	cmp dword [esp+16],1
	jz cswlop1
	jmp cswlop0
	
	align 16
cswlop0:
	movdqa xmm0,[ecx]
	movntdq [edx],xmm0
	lea ecx,[ecx+16]
	lea edx,[edx+16]
	dec eax
	jnz cswlop0
	ret
	
	align 16
cswlop6:
	movdqa xmm0,[ecx]
	psllw xmm0,6
	movntdq [edx],xmm0
	lea ecx,[ecx+16]
	lea edx,[edx+16]
	dec eax
	jnz cswlop6
	ret

	align 16
cswlop5:
	movdqa xmm0,[ecx]
	psllw xmm0,5
	movntdq [edx],xmm0
	lea ecx,[ecx+16]
	lea edx,[edx+16]
	dec eax
	jnz cswlop5
	ret

	align 16
cswlop4:
	movdqa xmm0,[ecx]
	psllw xmm0,4
	movntdq [edx],xmm0
	lea ecx,[ecx+16]
	lea edx,[edx+16]
	dec eax
	jnz cswlop4
	ret

	align 16
cswlop3:
	movdqa xmm0,[ecx]
	psllw xmm0,3
	movntdq [edx],xmm0
	lea ecx,[ecx+16]
	lea edx,[edx+16]
	dec eax
	jnz cswlop3
	ret

	align 16
cswlop2:
	movdqa xmm0,[ecx]
	psllw xmm0,2
	movntdq [edx],xmm0
	lea ecx,[ecx+16]
	lea edx,[edx+16]
	dec eax
	jnz cswlop2
	ret

	align 16
cswlop1:
	movdqa xmm0,[ecx]
	psllw xmm0,1
	movntdq [edx],xmm0
	lea ecx,[ecx+16]
	lea edx,[edx+16]
	dec eax
	jnz cswlop1
	ret

;void ImageUtil_UVInterleaveShiftW(UInt8 *destPtr, UInt8 *uptr, UInt8 *vptr, OSInt pixelCnt, OSInt shiftCnt);
;0 esi
;4 edi
;8 retAddr
;12 destPtr
;16 uptr
;20 vptr
;24 pixelCnt
;28 shiftCnt

	align 16
_ImageUtil_UVInterleaveShiftW:
ImageUtil_UVInterleaveShiftW:
	push edi
	push esi
	mov edi,dword [esp+12]
	mov esi,dword [esp+16]
	mov edx,dword [esp+20]
	mov ecx,dword [esp+24]
	shr ecx,3
	cmp dword [esp+28],6
	jz uviswlop6
	cmp dword [esp+28],4
	jz uviswlop4
	jmp uviswlop0
	
	align 16
uviswlop6:
	movdqa xmm0,[esi]
	psllw xmm0,6
	movdqa xmm1,[edx]
	psllw xmm1,6
	movdqa xmm2,xmm0
	punpcklwd xmm0,xmm1
	movntdq [edi],xmm0
	punpckhwd xmm2,xmm1
	movntdq [edi+16],xmm2
	lea edi,[edi+32]
	lea esi,[esi+16]
	lea edx,[edx+16]
	dec ecx
	jnz uviswlop6
	pop esi
	pop edi
	ret

	align 16
uviswlop4:
	movdqa xmm0,[esi]
	psllw xmm0,4
	movdqa xmm1,[edx]
	psllw xmm1,4
	movdqa xmm2,xmm0
	punpcklwd xmm0,xmm1
	movntdq [edi],xmm0
	punpckhwd xmm2,xmm1
	movntdq [edi+16],xmm2
	lea edi,[edi+32]
	lea esi,[esi+16]
	lea edx,[edx+16]
	dec ecx
	jnz uviswlop4
	pop esi
	pop edi
	ret

	align 16
uviswlop0:
	movdqa xmm0,[esi]
	movdqa xmm2,xmm0
	movdqa xmm1,[edx]
	punpcklwd xmm0,xmm1
	movntdq [edi],xmm0
	punpckhwd xmm2,xmm1
	movntdq [edi+16],xmm2
	lea edi,[edi+32]
	lea esi,[esi+16]
	lea edx,[edx+16]
	dec ecx
	jnz uviswlop0
	pop esi
	pop edi
	ret

;void ImageUtil_YUV_Y416ShiftW(UInt8 *destPtr, UInt8 *yptr, UInt8 *uptr, UInt8 *vptr, OSInt pixelCnt, OSInt shiftCnt);
;0 ebx
;4 edi
;8 esi
;12 retAddr
;16 destPtr
;20 yptr
;24 uptr
;28 vptr
;32 pixelCnt
;36 shiftCnt
	align 16
_ImageUtil_YUV_Y416ShiftW:
ImageUtil_YUV_Y416ShiftW:
	push esi
	push edi
	push ebx
	mov eax,-1
	movd xmm3,eax
	mov edi,dword [esp+16] ;destPtr
	mov esi,dword [esp+20] ;yptr
	mov ecx,dword [esp+24] ;uptr
	mov edx,dword [esp+28] ;vptr
	mov ebx,dword [esp+32] ;pixelCnt
	shr ebx,3
	punpckldq xmm3,xmm3
	punpckldq xmm3,xmm3
	cmp dword [esp+36],6
	jz yuvy416swlop6
	jmp yuvy416swlop0
	
	align 16
yuvy416swlop6:
	movdqu xmm0,[esi]
	movdqu xmm1,[ecx]
	psllw xmm0,6
	movdqu xmm2,[edx]
	psllw xmm1,6
	psllw xmm2,6
	movdqa xmm4,xmm1
	movdqa xmm5,xmm0
	punpcklwd xmm4,xmm2
	punpckhwd xmm1,xmm2
	punpcklwd xmm5,xmm3
	punpckhwd xmm0,xmm3
	movdqa xmm2,xmm4
	punpcklwd xmm4,xmm5
	movntdq [edi],xmm4
	punpckhwd xmm2,xmm5
	movntdq [edi+16],xmm2
	movdqa xmm2,xmm1
	punpcklwd xmm1,xmm0
	movntdq [edi+32],xmm1
	punpckhwd xmm2,xmm0
	movntdq [edi+48],xmm2
	lea edi,[edi+64]
	lea esi,[esi+16]
	lea ecx,[ecx+16]
	lea edx,[edx+16]
	dec ebx
	jnz yuvy416swlop6
	jmp yuvy416swexit
	
	align 16
yuvy416swlop0:
	movdqu xmm0,[esi]
	movdqu xmm1,[ecx]
	movdqa xmm5,xmm0
	movdqu xmm2,[edx]
	movdqa xmm4,xmm1
	punpcklwd xmm4,xmm2
	punpckhwd xmm1,xmm2
	punpcklwd xmm5,xmm3
	punpckhwd xmm0,xmm3
	movdqa xmm2,xmm4
	punpcklwd xmm4,xmm5
	movntdq [edi],xmm4
	punpckhwd xmm2,xmm5
	movntdq [edi+16],xmm2
	movdqa xmm2,xmm1
	punpcklwd xmm1,xmm0
	movntdq [edi+32],xmm1
	punpckhwd xmm2,xmm0
	movntdq [edi+48],xmm2
	lea edi,[edi+64]
	lea esi,[esi+16]
	lea ecx,[ecx+16]
	lea edx,[edx+16]
	dec ebx
	jnz yuvy416swlop0
	jmp yuvy416swexit
	
	align 16
yuvy416swexit:
	pop ebx
	pop edi
	pop esi
	ret

